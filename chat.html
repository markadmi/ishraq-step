<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8"/>
  <title>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="style/main.css">
  <style>
    /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
    .user-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .user-modal .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      width: 280px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      animation: pop 0.25s ease;
    }
    @keyframes pop {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .user-modal img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
    }
    .user-modal h3 {
      margin: 10px 0 5px;
    }
    .user-modal .muted {
      color: #666;
      font-size: 13px;
      margin-bottom: 10px;
    }
    .user-modal .btn {
      width: 100%;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card chat-col">
      <div class="chat-header">
        <h2>Ø¬Ø±ÙˆØ¨ Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† Ø¬Ø§Ù…Ø¹Ø© Ø³ÙˆÙ‡Ø§Ø¬</h2>
      </div>

      <div id="messages" class="messages"></div>

      <div class="composer">
        <input id="msgText" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
        <button id="sendBtn" class="btn">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>

    <div class="card side-col">
      <div id="sessionBox" class="session-box"></div>

      <div id="adminTools" class="admin-tools" style="display:none; margin-top:12px;">
        <h4>Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h4>
        <div class="muted small">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ­ÙƒÙ…</div>
        <button id="clearAllBtn" class="btn btn-danger" style="margin-top:10px;">Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ù…Ø³Ø¤ÙˆÙ„)</button>
      </div>

      <div style="margin-top:12px;">
        <button id="logoutBtn" class="btn btn-muted">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <!-- âœ… Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
  <div id="userModal" class="user-modal">
    <div class="modal-content">
      <img id="modalAvatar" src="" alt="">
      <h3 id="modalName"></h3>
      <div id="modalRole" class="muted"></div>
      <button id="banToggleBtn" class="btn btn-danger"></button>
      <button id="closeModal" class="btn btn-muted">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <script type="module" src="js/fb.js"></script>
  <script type="module">
    import { db } from './js/fb.js';
    import {
      ref as dbRef,
      push,
      onChildAdded,
      onChildRemoved,
      set,
      query,
      orderByChild,
      limitToFirst,
      get,
      remove,
      onValue
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const messagesDiv = document.getElementById('messages');
    const msgText = document.getElementById('msgText');
    const sendBtn = document.getElementById('sendBtn');
    const sessionBox = document.getElementById('sessionBox');
    const logoutBtn = document.getElementById('logoutBtn');
    const adminTools = document.getElementById('adminTools');
    const clearAllBtn = document.getElementById('clearAllBtn');

    // Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const userModal = document.getElementById('userModal');
    const modalAvatar = document.getElementById('modalAvatar');
    const modalName = document.getElementById('modalName');
    const modalRole = document.getElementById('modalRole');
    const banToggleBtn = document.getElementById('banToggleBtn');
    const closeModal = document.getElementById('closeModal');

    // Ø§Ù„Ø¬Ù„Ø³Ø©
    const s = localStorage.getItem('chat_session');
    if (!s) { window.location.href = 'index.html'; throw new Error('No session'); }
    const session = JSON.parse(s);
    let currentUser = session;
    currentUser.deviceId = localStorage.getItem('device_id');

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    function renderSession() {
      sessionBox.innerHTML = `
        <div class="session">
          <img src="${currentUser.avatarUrl}" class="avatar-sm" alt="avatar">
          <div style="margin-right:8px;">
            <div style="font-weight:700">${escapeHtml(currentUser.name)}</div>
            <div class="muted small">${escapeHtml(currentUser.role)}</div>
          </div>
        </div>
      `;
      if (currentUser.role === 'Ù…Ø³Ø¤ÙˆÙ„') adminTools.style.display = 'block';
    }
    renderSession();

    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¸Ø±
    const bansRef = dbRef(db, 'bans');
    let bans = {};
    onValue(bansRef, (snap) => {
      bans = snap.val() || {};
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    sendBtn.addEventListener('click', async () => {
      if (!currentUser) return alert('Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
      if (bans[currentUser.deviceId]) return alert('Ù‚Ø§Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ø­Ø¸Ø±Ùƒ Ù…Ù† Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©');

      const text = (msgText.value || '').trim();
      if (!text) return;
      try {
        const mRef = push(dbRef(db, 'messages'));
        await set(mRef, {
          type: 'msg',
          name: currentUser.name,
          avatar: currentUser.avatarUrl || '',
          role: currentUser.role || 'Ø·Ø§Ù„Ø¨',
          deviceId: currentUser.deviceId,
          text,
          timestamp: Date.now()
        });
        msgText.value = '';
        await trimMessagesIfNeeded();
      } catch (err) {
        console.error(err);
      }
    });
    msgText.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendBtn.click(); });

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    const messagesRef = dbRef(db, 'messages');
    onChildAdded(messagesRef, (snap) => {
      const m = snap.val();
      if (!m) return;
      if (bans[m.deviceId]) return; // Ù„Ø§ ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø¸ÙˆØ±
      appendMessage(m, snap.key);
    });
    onChildRemoved(messagesRef, (snap) => {
      const msgEl = document.getElementById(`msg-${snap.key}`);
      if (msgEl) msgEl.remove();
    });

    // ğŸ§© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ Ø²Ø± Ø§Ù„ØµÙˆØ±Ø© Ù„ÙØªØ­ Ø§Ù„ØªØ­ÙƒÙ…
    function appendMessage(m, key) {
      const wrap = document.createElement('div');
      wrap.className = 'msg-row';
      wrap.id = `msg-${key}`;

      const avatar = document.createElement('img');
      avatar.className = 'avatar';
      avatar.src = m.avatar || '';
      avatar.alt = m.name || '';

      // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø©
      avatar.addEventListener('click', () => {
        if (currentUser.role !== 'Ù…Ø³Ø¤ÙˆÙ„') return; // ÙÙ‚Ø· Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
        openUserModal(m);
      });

      const body = document.createElement('div');
      body.className = 'msg-body';
      body.innerHTML = `<div class="msg-head">
                          <span class="role">${escapeHtml(m.role || 'Ø·Ø§Ù„Ø¨')}</span> 
                          <strong>${escapeHtml(m.name || 'Ù…Ø³ØªØ®Ø¯Ù…')}</strong> 
                        </div>
                        <div class="msg-text">${escapeHtml(m.text || '')}</div>`;

      wrap.appendChild(avatar);
      wrap.appendChild(body);
      messagesDiv.appendChild(wrap);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // âœ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function openUserModal(user) {
      modalAvatar.src = user.avatar || '';
      modalName.innerText = user.name || 'Ù…Ø³ØªØ®Ø¯Ù…';
      modalRole.innerText = `Ø§Ù„Ø¯ÙˆØ±: ${user.role || ''}`;
      const isBanned = !!bans[user.deviceId];

      banToggleBtn.innerText = isBanned ? 'ÙÙƒ Ø§Ù„Ø­Ø¸Ø±' : 'Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
      banToggleBtn.className = isBanned ? 'btn btn-primary' : 'btn btn-danger';

      banToggleBtn.onclick = async () => {
        try {
          if (isBanned) {
            await remove(dbRef(db, `bans/${user.deviceId}`));
            alert(`${user.name} ØªÙ… ÙÙƒ Ø§Ù„Ø­Ø¸Ø±`);
          } else {
            await set(dbRef(db, `bans/${user.deviceId}`), {
              name: user.name,
              timestamp: Date.now()
            });
            alert(`${user.name} ØªÙ… Ø­Ø¸Ø±Ù‡`);
          }
          closeModal.click();
        } catch (err) {
          console.error(err);
        }
      };

      userModal.style.display = 'flex';
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
    closeModal.addEventListener('click', () => { userModal.style.display = 'none'; });
    userModal.addEventListener('click', (e) => {
      if (e.target === userModal) userModal.style.display = 'none';
    });

    // Ø­Ø°Ù Ø§Ù„ÙƒÙ„
    clearAllBtn.addEventListener('click', async () => {
      if (currentUser.role !== 'Ù…Ø³Ø¤ÙˆÙ„') return alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„');
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŸ')) return;
      try {
        await set(dbRef(db, 'messages'), null);
        alert('ØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„');
      } catch (err) { console.error(err); }
    });

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    logoutBtn.addEventListener('click', async () => {
      try {
        const mRef = push(dbRef(db, 'messages'));
        await set(mRef, {
          type: 'leave',
          name: currentUser.name,
          avatar: currentUser.avatarUrl || '',
          role: currentUser.role || '',
          text: `${currentUser.name} â–ªï¸ ØºØ§Ø¯Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©`,
          timestamp: Date.now()
        });
      } catch(e){}
      localStorage.removeItem('chat_session');
      window.location.href = 'index.html';
    });

    // Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
    function escapeHtml(text){ if(!text) return ''; return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    async function trimMessagesIfNeeded() {
      try {
        const q = query(dbRef(db, 'messages'), orderByChild('timestamp'));
        const snap = await get(q);
        if (!snap.exists()) return;
        const data = snap.val();
        const keys = Object.keys(data);
        if (keys.length <= 30) return;
        const removeCount = keys.length - 30;
        const q2 = query(dbRef(db, 'messages'), orderByChild('timestamp'), limitToFirst(removeCount));
        const snap2 = await get(q2);
        if (!snap2.exists()) return;
        const old = snap2.val();
        for (const k of Object.keys(old)) {
          await remove(dbRef(db, `messages/${k}`));
        }
      } catch (err) { console.error('trim error', err); }
    }

    setInterval(() => { trimMessagesIfNeeded(); }, 10000);
  </script>
</body>
</html>