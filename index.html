<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8"/>
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ â€” Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="style/main.css">

  <style>
    /* ğŸ¨ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¨Ø±ÙˆØ¬Ø±ÙŠØ³ */
    .progress-container {
      width: 100%;
      background: #f0f0f0;
      border-radius: 20px;
      overflow: hidden;
      height: 12px;
      margin-top: 10px;
      display: none;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #007bff, #00d4ff);
      transition: width 0.3s ease;
    }
    .progress-text {
      text-align: center;
      font-size: 13px;
      color: #555;
      margin-top: 6px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="center-card">
    <div class="card">
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©</h2>
      <p class="muted">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ ÙˆØµÙˆØ±ØªÙƒ. Ø¥Ù† Ø£Ø¯Ø®Ù„Øª ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø³ØªØµØ¨Ø­ "Ù…Ø³Ø¤ÙˆÙ„".</p>

      <label>Ø§Ù„Ø§Ø³Ù…</label>
      <input id="name" type="text" placeholder="Ø§Ø³Ù…Ùƒ">

      <label>ØµÙˆØ±ØªÙƒ (Avatar)</label>
      <input id="avatarFile" type="file" accept="image/*">

      <label>Ù…ÙˆÙ‚Ø¹Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø£Ùˆ Ø§ØªØ±ÙƒØ© ÙØ§Ø±Øº)</label>
      <input id="location" type="text" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±Øº">

      <div style="display:flex; gap:8px; margin-top:10px;">
        <button id="enterBtn" class="btn">Ø¯Ø®ÙˆÙ„</button>
        <button id="clearBtn" class="btn btn-muted">ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
      </div>

      <!-- âœ… Ø§Ù„Ø¨Ø±ÙˆØ¬Ø±ÙŠØ³ Ø¨Ø§Ø± -->
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="progress-text" id="progressText">Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...</div>

      <div id="info" class="small muted" style="margin-top:10px;"></div>
      <div class="small muted" style="margin-top:12px;">
      
      </div>
    </div>
  </div>

  <script type="module" src="js/fb.js"></script>
  <script type="module">
    import { db, storage } from './js/fb.js';
    import { ref as dbRef, push, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { ref as storageRef, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    
    const logo = "shoag-eg"; 

    const nameEl = document.getElementById('name');
    const avatarFileEl = document.getElementById('avatarFile');
    const locationEl = document.getElementById('location');
    const enterBtn = document.getElementById('enterBtn');
    const clearBtn = document.getElementById('clearBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const infoDiv = document.getElementById('info');

    function setInfo(t) { infoDiv.innerText = t; }

    function getDeviceId() {
      let id = localStorage.getItem('device_id');
      if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem('device_id', id);
      }
      return id;
    }
    const deviceId = getDeviceId();

    enterBtn.addEventListener('click', async () => {
      const name = (nameEl.value || '').trim();
      const pass = locationEl.value || '';
      const file = avatarFileEl.files[0];

      if (!name) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…');
      if (!file) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©');

      // âœ… Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
      progressContainer.style.display = 'block';
      progressText.style.display = 'block';
      progressBar.style.width = '0%';
      progressText.innerText = 'Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...';

      try {
        const stamp = Date.now();
        const safe = name.replace(/[^\w\-Ø¡-ÙŠ ]/g,'').replace(/ /g,'_').slice(0,40);
        const path = `avatars/${safe}_${stamp}.png`;
        const sRef = storageRef(storage, path);

        // âœ… Ø§Ø³ØªØ®Ø¯Ù… uploadBytesResumable Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙ‚Ø¯Ù… Ø§Ù„Ø±ÙØ¹
        const uploadTask = uploadBytesResumable(sRef, file);

        uploadTask.on('state_changed', 
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progressBar.style.width = progress.toFixed(0) + '%';
            progressText.innerText = `Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©... ${progress.toFixed(0)}%`;
          }, 
          (error) => {
            console.error(error);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©.');
            progressText.innerText = 'ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ âŒ';
          }, 
          async () => {
            const avatarUrl = await getDownloadURL(uploadTask.snapshot.ref);

            // Ø§Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const userRef = push(dbRef(db, 'users'));
            const role = (pass === logo) ? 'Ù…Ø³Ø¤ÙˆÙ„' : 'Ø·Ø§Ù„Ø¨';

            await set(userRef, {
              name,
              avatarUrl,
              role,
              deviceId,
              joinedAt: Date.now()
            });

            const session = { userKey: userRef.key, deviceId, name, avatarUrl, role };
            localStorage.setItem('chat_session', JSON.stringify(session));

            // Ø£Ø¶Ù Ø±Ø³Ø§Ù„Ø© Ø§Ù†Ø¶Ù…Ø§Ù…
            const msgRef = push(dbRef(db, 'messages'));
            await set(msgRef, {
              type: 'join',
              name,
              avatar: avatarUrl,
              role,
              text: `${name} Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©`,
              timestamp: Date.now()
            });

            progressText.innerText = 'ØªÙ… Ø§Ù„Ø±ÙØ¹ âœ… Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
            setTimeout(() => window.location.href = 'chat.html', 700);
          }
        );
      } catch (err) {
        console.error(err);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.');
        setInfo('');
      }
    });

    clearBtn.addEventListener('click', () => {
      nameEl.value = '';
      locationEl.value = '';
      avatarFileEl.value = '';
      setInfo('');
      progressContainer.style.display = 'none';
      progressText.style.display = 'none';
    });

    const s = localStorage.getItem('chat_session');
    if (s) {
      window.location.href = 'chat.html';
    }
  </script>
</body>
</html>