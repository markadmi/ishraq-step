<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨ - Ishraq Step</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link href="css/buttons.css" rel="stylesheet">
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; direction: rtl; }
    header { text-align: center; font-size: 28px; font-weight: bold; margin-bottom: 30px; color: #333; }
    .back-btn { background: #999; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; text-decoration: none; display: inline-block; margin-bottom: 20px; }
    .back-btn:hover { background: #666; }
    .details-container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .book-header { display: flex; gap: 30px; margin-bottom: 30px; flex-wrap: wrap; }
    .book-cover { flex: 0 0 250px; }
    .book-cover img { width: 100%; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .book-info { flex: 1; min-width: 300px; }
    .book-title { font-size: 28px; font-weight: 800; margin: 0 0 15px 0; color: #333; }
    .book-meta { font-size: 16px; color: #666; margin: 10px 0; line-height: 1.8; }
    .book-meta strong { color: #333; }
    .section { margin: 30px 0; }
    .section-title { font-size: 20px; font-weight: 600; margin-bottom: 15px; color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
    .section-content { font-size: 16px; color: #666; line-height: 1.8; }
    .action-buttons { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px; }
    .download-btn { background-color: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600; transition: background-color 0.3s; text-decoration: none; display: inline-block; }
    .download-btn:hover { background-color: #45a049; }
    .loading { text-align: center; font-size: 18px; color: #666; padding: 40px; }
    .error { text-align: center; font-size: 18px; color: #d32f2f; padding: 40px; }
    @media (max-width: 600px) { .book-header { flex-direction: column; } .book-cover { flex: 0 0 auto; } .book-title { font-size: 22px; } }
    .qr-section { text-align: center; margin: 30px 0; padding: 20px; background: #f9f9f9; border-radius: 8px; }
    .qr-section h3 { margin: 0 0 15px 0; color: #333; }
    #qrcode { display: inline-block; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  </style>
</head>

<body>
  <header>ğŸ“– ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨</header>
  <div class="details-container">
    <a href="Downloads.html" class="back-btn">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙƒØªØ¨Ø©</a>
    <div id="content">
      <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„...</div>
    </div>
  </div>

  <script type="module">
    import { db } from './chat/js/fb.js';
    import { ref as dbRef, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const contentDiv = document.getElementById('content');

    function esc(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function dateLabel(d){ if(!d) return ''; try{ return new Date(d).toLocaleDateString('ar-SA'); }catch(e){return ''} }

    function getQueryParam(name){
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    const bookId = getQueryParam('id');

    if(!bookId){
      contentDiv.innerHTML = '<div class="error">Ù…Ø¹Ø±Ù Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·</div>';
    } else {
      get(dbRef(db, 'books/' + bookId)).then(snapshot => {
        if(!snapshot.exists()){
          contentDiv.innerHTML = '<div class="error">Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>';
          return;
        }
        const book = snapshot.val();
        contentDiv.innerHTML = `
          <div class="book-header">
            <div class="book-cover">
              <img src="${esc(book.coverUrl || 'https://picsum.photos/300/420')}" alt="cover">
            </div>
            <div class="book-info">
              <h1 class="book-title">${esc(book.title)}</h1>
              <div class="book-meta"><strong>Ø§Ù„Ù…Ø¤Ù„Ù:</strong> ${esc(book.author || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')}</div>
              <div class="book-meta"><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${esc(book.category || 'Ø¨Ø¯ÙˆÙ† Ù‚Ø³Ù…')}</div>
              <div class="book-meta"><strong>Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª:</strong> ${esc(book.pages || 'â€”')}</div>
              <div class="book-meta"><strong>Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù:</strong> ${esc(book.size || 'â€”')}</div>
              <div class="book-meta"><strong>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</strong> ${typeof book.rating !== 'undefined' ? esc(book.rating) : 'â€”'}</div>
              <div class="book-meta"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±:</strong> ${dateLabel(book.createdAt)}</div>
              <div class="action-buttons">
                ${book.fileUrl ? `<a class="download-btn" href="${esc(book.fileUrl)}" download>â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨</a>` : '<span style="color:#999">Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ØªØ§Ø­</span>'}
              </div>
            </div>
          </div>
          ${book.description ? `
            <div class="section">
              <h2 class="section-title">Ø§Ù„ÙˆØµÙ</h2>
              <div class="section-content">${esc(book.description)}</div>
            </div>
          ` : ''}
          ${book.content ? `
            <div class="section">
              <h2 class="section-title">Ù…Ø­ØªÙˆÙ‰ Ø¥Ø¶Ø§ÙÙŠ</h2>
              <div class="section-content">${esc(book.content)}</div>
            </div>
          ` : ''}
          <div class="qr-section">
            <h3>Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ÙƒØªØ§Ø¨</h3>
            <div id="qrcode"></div>
            <div style="margin-top:12px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
              <button id="shareBtn" class="download-btn" type="button">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©</button>
              <button id="copyBtn" class="download-btn" type="button">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
            </div>
            <p id="linkText" style="margin-top:8px;color:#666;font-size:14px;display:none;word-break:break-all"></p>
            <p style="margin-top:15px;color:#666;font-size:14px">Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ÙƒØªØ§Ø¨</p>
          </div>
        `;
        // ØªÙ†ÙÙŠØ° QR Code + Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« HTML
        setTimeout(() => {
          const qEl = document.getElementById("qrcode");
          const url = window.location.href;
          if (qEl && window.QRCode) {
            new QRCode(qEl, { text: url, width: 200, height: 200, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H });
          }
          const shareBtn = document.getElementById('shareBtn');
          const copyBtn = document.getElementById('copyBtn');
          const linkText = document.getElementById('linkText');

          if (shareBtn) {
            shareBtn.addEventListener('click', async () => {
              try {
                if (navigator.share) {
                  await navigator.share({ title: book.title || 'ØªÙØ§ØµÙŠÙ„ ÙƒØªØ§Ø¨', text: book.title || '', url });
                } else {
                  linkText.textContent = url;
                  linkText.style.display = 'block';
                }
              } catch (e) { /* ØªØ¬Ø§Ù‡Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© */ }
            });
          }

          if (copyBtn) {
            copyBtn.addEventListener('click', async () => {
              try {
                await navigator.clipboard.writeText(url);
                copyBtn.textContent = 'âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®';
                setTimeout(() => { copyBtn.textContent = 'ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·'; }, 2000);
              } catch (e) {
                // Ø¨Ø¯ÙŠÙ„: Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®
                linkText.textContent = url;
                linkText.style.display = 'block';
              }
            });
          }
        }, 100);
      }).catch(err => {
        contentDiv.innerHTML = '<div class="error">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨</div>';
        console.error(err);
      });
    }
  </script>
</body>
</html>