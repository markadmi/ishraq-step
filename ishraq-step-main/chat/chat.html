<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>Ø³Ø§Ø­Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© - Ishraq Step</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4496926993663116" crossorigin="anonymous"></script>

  <style>
    :root {
      --primary-orange: #ff8a00;
      --primary-yellow: #ffd166;
      --glass-bg: rgba(20, 20, 20, 0.6);
      --glass-border: rgba(255, 255, 255, 0.1);
      --msg-me-bg: linear-gradient(135deg, var(--primary-orange), var(--primary-yellow));
      --msg-other-bg: rgba(255, 255, 255, 0.08);
      --danger: #ff4b4b;
      --success: #00b09b;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Cairo', sans-serif;
      background-color: #000000;
      background-image: radial-gradient(circle at 50% 0%, #111 0%, #000 100%);
      height: 100vh;
      overflow: hidden;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* --- Ø®Ù„ÙÙŠØ© Ù…ØªØ­Ø±ÙƒØ© --- */
    .bg-shape {
      position: fixed;
      border-radius: 50%;
      filter: blur(90px);
      z-index: -1;
      opacity: 0.25;
      animation: float 20s infinite alternate;
    }
    .shape-1 { width: 400px; height: 400px; background: var(--primary-orange); top: -100px; left: -100px; }
    .shape-2 { width: 500px; height: 500px; background: #004e92; bottom: -150px; right: -150px; }
    @keyframes float { from { transform: translate(0,0); } to { transform: translate(30px, 50px); } }

    /* --- Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- */
    .wrap {
      width: 95%;
      max-width: 900px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ù„ÙŠÙƒÙˆÙ† Ù…Ù†Ø§Ø³Ø¨Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
      height: 90vh;
      position: relative;
      margin: 0 auto;
    }

    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      overflow: hidden;
      height: 100%; /* ØªØ£Ø®Ø° ÙƒØ§Ù…Ù„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØºÙ„Ø§Ù */
    }

    /* --- Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© --- */
    .chat-header {
      padding: 15px 20px;
      border-bottom: 1px solid var(--glass-border);
      background: rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .chat-info h2 {
      font-size: 18px;
      font-weight: 700;
      background: linear-gradient(to right, #fff, #ccc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .chat-info span {
      font-size: 12px; color: #aaa;
    }

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø¯ÙˆØ§Øª ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± (Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„) */
    .header-tools {
      display: flex;
      gap: 10px;
    }
    .tool-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid var(--glass-border);
      color: #fff;
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: 0.3s;
      display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    }
    .tool-btn:hover { background: rgba(255,255,255,0.2); }
    .tool-btn.danger { color: #ff4b4b; border-color: rgba(255, 75, 75, 0.3); }
    .tool-btn.warning { color: var(--primary-yellow); border-color: rgba(255, 209, 102, 0.3); }

    /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ --- */
    .messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      scroll-behavior: smooth;
    }
    
    .messages::-webkit-scrollbar { width: 6px; }
    .messages::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ù„Ø© --- */
    .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 10px;
      max-width: 80%;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .msg-row.me {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .avatar {
      width: 35px; height: 35px;
      border-radius: 50%;
      border: 2px solid var(--glass-border);
      object-fit: cover;
      cursor: pointer;
    }

    .msg-body {
      padding: 10px 15px;
      border-radius: 18px;
      position: relative;
      font-size: 14px;
      line-height: 1.5;
    }

    .msg-row.other .msg-body {
      background: var(--msg-other-bg);
      border-bottom-right-radius: 4px; 
      color: #eee;
    }

    .msg-row.me .msg-body {
      background: var(--msg-me-bg);
      border-bottom-left-radius: 4px;
      color: #000;
      font-weight: 600;
      box-shadow: 0 0 15px rgba(255, 138, 0, 0.3);
    }

    .msg-head {
      font-size: 11px;
      margin-bottom: 4px;
      opacity: 0.7;
      display: flex;
      gap: 5px;
    }
    .role-badge {
      background: rgba(255,255,255,0.2);
      padding: 1px 6px;
      border-radius: 4px;
      font-size: 10px;
    }

    /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© --- */
    .composer {
      padding: 15px;
      background: rgba(0,0,0,0.3);
      border-top: 1px solid var(--glass-border);
      display: flex;
      gap: 10px;
    }
    .composer input {
      flex: 1;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--glass-border);
      padding: 12px 20px;
      border-radius: 30px;
      color: #fff;
      font-family: 'Cairo';
      outline: none;
      transition: 0.3s;
    }
    .composer input:focus {
      border-color: var(--primary-orange);
      box-shadow: 0 0 10px rgba(255, 138, 0, 0.1);
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 30px;
      font-family: 'Cairo';
      font-weight: 700;
      cursor: pointer;
      transition: 0.3s;
    }
    .btn-primary { background: var(--msg-me-bg); color: #000; }
    .btn-primary:hover { transform: scale(1.05); }

    /* --- Modal --- */
    .user-modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center; justify-content: center;
      z-index: 9999;
    }
    .modal-content {
      background: #1a1a1a;
      border: 1px solid var(--glass-border);
      padding: 30px;
      border-radius: 20px;
      width: 300px;
      text-align: center;
      animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    .avatar-lg { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--primary-orange); margin-bottom: 10px; object-fit: cover; }

    /* --- Loading Overlay --- */
    .loading-overlay {
      position: fixed; inset: 0; background: #000; z-index: 10000;
      display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 15px;
      transition: opacity 0.5s;
    }
    .loading-overlay.hidden { opacity: 0; pointer-events: none; }
    
    .spinner {
      width: 50px; height: 50px;
      border: 3px solid rgba(255, 138, 0, 0.3);
      border-top-color: var(--primary-orange);
      border-radius: 50%;
      animation: spin 1s infinite linear;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .wrap { width: 100%; height: 100vh; border-radius: 0; }
      .card { border-radius: 0; border: none; }
    }
  </style>
</head>
<body>

  <div class="bg-shape shape-1"></div>
  <div class="bg-shape shape-2"></div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text" style="color:#888;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
  </div>

  <div class="wrap">
    <div class="card chat-col">
      <div class="chat-header">
        <div class="chat-info">
          <h2>ğŸ”¥ Ø¬Ø±ÙˆØ¨ Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† Ø¬Ø§Ù…Ø¹Ø© Ø³ÙˆÙ‡Ø§Ø¬</h2>
          <div id="statusText">Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</div>
        </div>
        
        <div class="header-tools" id="adminTools">
          <button id="toggleChatBtn" class="tool-btn warning">â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
          <button id="clearAllBtn" class="tool-btn danger">ğŸ—‘ Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
        </div>
      </div>

      <div id="messages" class="messages"></div>

      <div class="composer">
        <input id="msgText" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...">
        <button id="sendBtn" class="btn btn-primary">Ø¥Ø±Ø³Ø§Ù„ ğŸš€</button>
      </div>
    </div>
  </div>

  <div id="userModal" class="user-modal">
    <div class="modal-content">
      <img id="modalAvatar" src="" class="avatar-lg" alt="">
      <h3 id="modalName" style="color:#fff; margin:10px 0;"></h3>
      <div id="modalRole" style="color:var(--primary-orange); margin-bottom:20px; font-size:14px;"></div>
      
      <button id="banToggleBtn" class="btn" style="width:100%; margin-bottom:10px;"></button>
      <button id="closeModal" class="btn btn-muted" style="background:transparent; color:#888; border:1px solid #444; width:100%;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <script type="module">
    import { db } from './js/fb.js';
    import {
      ref as dbRef,
      push,
      onChildAdded,
      onChildRemoved,
      set,
      query,
      orderByChild,
      limitToFirst,
      get,
      remove,
      onValue,
      update
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // === Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© ===
    const s = localStorage.getItem('chat_session');
    if (!s) {
      window.location.href = 'start.html';
      throw new Error('Not logged in'); 
    }

    const session = JSON.parse(s);
    let currentUser = session;
    currentUser.deviceId = localStorage.getItem('device_id');

    // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const loadingOverlay = document.getElementById('loadingOverlay');
    const messagesDiv = document.getElementById('messages');
    const msgText = document.getElementById('msgText');
    const sendBtn = document.getElementById('sendBtn');
    
    // Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±)
    const adminTools = document.getElementById('adminTools');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const toggleChatBtn = document.getElementById('toggleChatBtn');
    const statusText = document.getElementById('statusText');

    // Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    const userModal = document.getElementById('userModal');
    const modalAvatar = document.getElementById('modalAvatar');
    const modalName = document.getElementById('modalName');
    const modalRole = document.getElementById('modalRole');
    const banToggleBtn = document.getElementById('banToggleBtn');
    const closeModal = document.getElementById('closeModal');

    // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¤ÙˆÙ„Ø§Ù‹ Ø£Ùˆ Ø±Ø¦ÙŠØ³Ø§Ù‹
    if (currentUser.role === 'Ø±Ø¦ÙŠØ³' || currentUser.role === 'Ù…Ø³Ø¤ÙˆÙ„') {
      adminTools.style.display = 'flex'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¸Ø±
    const bansRef = dbRef(db, 'bans');
    let bans = {};
    onValue(bansRef, (snap) => {
      bans = snap.val() || {};
      loadingOverlay.classList.add('hidden');
    });

    // Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Ù…ÙØªÙˆØ­Ø©/Ù…ØºÙ„Ù‚Ø©)
    const chatStatusRef = dbRef(db, 'chat_status');
    let chatOpen = true;
    onValue(chatStatusRef, (snap) => {
      const val = snap.val();
      chatOpen = val ? val.open : true;
      
      if(chatOpen) {
          statusText.innerText = "ğŸŸ¢ Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†";
          statusText.style.color = "#00ff88";
          toggleChatBtn.innerText = 'â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù';
          toggleChatBtn.className = "tool-btn warning";
      } else {
          statusText.innerText = "ğŸ”´ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ØºÙ„Ù‚Ø©";
          statusText.style.color = "#ff4b4b";
          toggleChatBtn.innerText = 'â–¶ï¸ ÙØªØ­';
          toggleChatBtn.className = "tool-btn success";
          toggleChatBtn.style.borderColor = "#00b09b";
          toggleChatBtn.style.color = "#00b09b";
      }
    });

    toggleChatBtn.addEventListener('click', async () => {
      if (currentUser.role !== 'Ø±Ø¦ÙŠØ³') return alert('Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø§ØµÙŠØ© Ù„Ù„Ø±Ø¦ÙŠØ³ ÙÙ‚Ø·');
      await set(chatStatusRef, { open: !chatOpen });
    });

    // === Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ===
    sendBtn.addEventListener('click', sendMessage);
    msgText.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });

    async function sendMessage() {
      if (!chatOpen) return alert('â›” Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ØºÙ„Ù‚Ø© Ù…Ø¤Ù‚ØªØ§Ù‹');
      if (bans[currentUser.deviceId]) return alert('ğŸš« Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ±');

      const text = (msgText.value || '').trim();
      if (!text) return;

      try {
        const mRef = push(dbRef(db, 'messages'));
        await set(mRef, {
          type: 'msg',
          name: currentUser.name,
          avatar: currentUser.avatarUrl || '',
          role: currentUser.role || 'Ø·Ø§Ù„Ø¨',
          deviceId: currentUser.deviceId,
          text,
          timestamp: Date.now()
        });
        msgText.value = '';
        msgText.focus();
        await trimMessagesIfNeeded();
      } catch (err) { console.error(err); }
    }

    // === Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ===
    const messagesRef = dbRef(db, 'messages');
    
    onChildAdded(messagesRef, (snap) => {
      const m = snap.val();
      if (!m) return;
      if (bans[m.deviceId]) return; 
      appendMessage(m, snap.key);
    });

    onChildRemoved(messagesRef, (snap) => {
      const msgEl = document.getElementById(`msg-${snap.key}`);
      if (msgEl) msgEl.remove();
    });

    function appendMessage(m, key) {
      const isMe = (m.deviceId === currentUser.deviceId);
      
      const wrap = document.createElement('div');
      wrap.className = `msg-row ${isMe ? 'me' : 'other'}`;
      wrap.id = `msg-${key}`;

      const avatar = document.createElement('img');
      avatar.className = 'avatar';
      avatar.src = m.avatar || 'https://via.placeholder.com/40';
      
      avatar.addEventListener('click', () => {
        if (currentUser.role === 'Ù…Ø³Ø¤ÙˆÙ„' || currentUser.role === 'Ø±Ø¦ÙŠØ³') {
           if (!isMe) openUserModal(m); 
        }
      });

      const body = document.createElement('div');
      body.className = 'msg-body';
      
      const roleText = m.role ? `<span class="role-badge">${m.role}</span>` : '';
      
      let headerHtml = '';
      if(!isMe) {
          headerHtml = `
            <div class="msg-head">
               ${roleText} <strong>${escapeHtml(m.name)}</strong>
            </div>
          `;
      }

      body.innerHTML = `
        ${headerHtml}
        <div class="msg-text">${escapeHtml(m.text)}</div>
      `;

      wrap.appendChild(avatar);
      wrap.appendChild(body);
      messagesDiv.appendChild(wrap);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // === Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¸Ø± (Modal) ===
    function openUserModal(user) {
      modalAvatar.src = user.avatar || '';
      modalName.innerText = user.name || 'Ù…Ø³ØªØ®Ø¯Ù…';
      modalRole.innerText = user.role || 'Ø¹Ø¶Ùˆ';
      
      const isBanned = !!bans[user.deviceId];

      if (isBanned) {
        banToggleBtn.innerText = 'âœ… ÙÙƒ Ø§Ù„Ø­Ø¸Ø±';
        banToggleBtn.className = 'btn btn-primary';
      } else {
        banToggleBtn.innerText = 'ğŸš« Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
        banToggleBtn.className = 'btn btn-danger';
        banToggleBtn.style.background = '#ff4b4b';
        banToggleBtn.style.color = '#fff';
      }

      banToggleBtn.onclick = async () => {
        try {
          if (isBanned) {
            await remove(dbRef(db, `bans/${user.deviceId}`));
          } else {
            await set(dbRef(db, `bans/${user.deviceId}`), {
              name: user.name,
              timestamp: Date.now()
            });
          }
          closeModal.click();
        } catch (err) { console.error(err); }
      };

      userModal.style.display = 'flex';
    }

    closeModal.addEventListener('click', () => { userModal.style.display = 'none'; });
    userModal.addEventListener('click', (e) => { if (e.target === userModal) userModal.style.display = 'none'; });

    // === Ø­Ø°Ù Ø§Ù„ÙƒÙ„ ===
    clearAllBtn.addEventListener('click', async () => {
      if (currentUser.role !== 'Ù…Ø³Ø¤ÙˆÙ„' && currentUser.role !== 'Ø±Ø¦ÙŠØ³') return;
      if (!confirm('âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù„Ù„Ø¬Ù…ÙŠØ¹!')) return;
      try {
        await set(dbRef(db, 'messages'), null);
      } catch (err) { console.error(err); }
    });

    function escapeHtml(text){
      if(!text) return '';
      return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    async function trimMessagesIfNeeded() {
      try {
        const q = query(dbRef(db, 'messages'), orderByChild('timestamp'));
        const snap = await get(q);
        if (!snap.exists()) return;
        
        const data = snap.val();
        const keys = Object.keys(data);
        const MAX_MSGS = 50;
        
        if (keys.length > MAX_MSGS) {
          const removeCount = keys.length - MAX_MSGS;
          const q2 = query(dbRef(db, 'messages'), orderByChild('timestamp'), limitToFirst(removeCount));
          const snap2 = await get(q2);
          
          if (snap2.exists()) {
             const updates = {};
             snap2.forEach(child => {
                 updates[child.key] = null;
             });
             await update(dbRef(db, 'messages'), updates);
          }
        }
      } catch (err) { console.error('trim error', err); }
    }

    setInterval(() => trimMessagesIfNeeded(), 20000);

  </script>
</body>
</html>