<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù„Ø¯Ø±Ø³ - Ishraq Step</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<style>
    /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¥Ø´Ø±Ø§Ù‚ Ø³ØªÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Cairo', sans-serif;
      background: #0a0a0a;
      color: white;
      min-height: 100vh;
      padding: 30px 20px;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    .back-btn {
      display: inline-flex; align-items: center; background: rgba(255, 255, 255, 0.1);
      color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none;
      margin-bottom: 20px; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); font-weight: 600;
    }

    .lesson-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
    
    .info-section, .editor-section {
      background: #151515; border-radius: 15px; padding: 30px;
      border: 1px solid #333;
    }
    
    .lesson-title { color: #dd8448; font-weight: 800; font-size: 1.2rem; }
    h1 { margin: 10px 0; font-size: 2rem; }

    /* --- ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø±Ø± - Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¥Ø²Ø§Ø­Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ --- */
    .editor-container {
      position: relative; 
      width: 100%; 
      height: 350px;
      background: #1e1e1e; 
      border-radius: 8px; 
      overflow: hidden;
      border: 1px solid #444; 
      margin-bottom: 15px; 
      direction: ltr; 
      text-align: left;
    }

    /* Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø¨Ù‚Ø© ØªØ¶Ù…Ù† Ø£Ù† Ø§Ù„Ù†ØµÙˆØµ ÙÙˆÙ‚ Ø¨Ø¹Ø¶Ù‡Ø§ Ø¨Ø§Ù„Ù…Ù„ÙŠ */
    .editor-layer {
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%;
      padding: 20px !important; /* Ø­Ø´Ùˆ Ø«Ø§Ø¨Øª ÙˆÙ…ÙˆØ­Ø¯ */
      margin: 0 !important;
      border: none !important;
      outline: none !important;
      
      /* ØªØ«Ø¨ÙŠØª Ù†ÙˆØ¹ ÙˆØ­Ø¬Ù… Ø§Ù„Ø®Ø· ÙˆØ§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø³Ø·Ø± */
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important; 
      font-size: 16px !important; 
      line-height: 24px !important; /* Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙƒØ³Ù„ Ø£Ø¯Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ */
      
      white-space: pre !important; /* Ù…Ù†Ø¹ Ø§Ù„ØªÙØ§Ù Ø§Ù„Ù†Øµ Ù„Ø¶Ù…Ø§Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø³Ø·Ø± */
      word-wrap: normal !important;
      overflow: auto;
      tab-size: 4;
      -moz-tab-size: 4;
    }

    #codeEditor {
      z-index: 2; 
      background: transparent !important; 
      color: transparent !important; 
      -webkit-text-fill-color: transparent !important; 
      caret-color: white; /* Ø¥Ø¨Ù‚Ø§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù…Ø±Ø¦ÙŠØ§Ù‹ */
      resize: none; 
      /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù…Ø²Ø§Ù…Ù†ØªÙ‡ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ø£Ùˆ ØªÙˆØ­ÙŠØ¯Ù‡ */
    }

    #highlightingArea { 
      z-index: 1; 
      color: #f8f8f2; 
      pointer-events: none; /* Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ù„ÙˆÙ†Ø© Ù„Ø§ ØªØ¹ÙŠÙ‚ Ø§Ù„ÙƒØªØ§Ø¨Ø© */
      background: transparent;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ù„ÙˆÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø·Ø¨Ù‚Ø© */
    #highlightingCode {
      font-family: inherit !important;
      font-size: inherit !important;
      line-height: inherit !important;
      padding: 0 !important;
      margin: 0 !important;
      display: block;
    }

    /* --- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… --- */
    .button-group { display: flex; gap: 10px; margin-top: 10px; }
    .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; color: white; flex: 1; transition: 0.3s; font-family: 'Cairo'; }
    .btn-run { background: #667eea; } 
    .btn-check { background: #4caf50; } 
    
    .output-section { 
      background: #000; border-radius: 8px; padding: 15px; color: #00ff00; 
      min-height: 80px; margin-top: 15px; font-family: monospace; direction: ltr;
    }
    
    .result-message { padding: 15px; border-radius: 8px; margin-top: 15px; display: none; text-align: center; font-weight: bold; }
    .result-message.success { background: #2e7d32; color: white; }
    .result-message.error { background: #c62828; color: white; }
    
    .spinner { width: 50px; height: 50px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #dd8448; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 1024px) { .lesson-wrapper { grid-template-columns: 1fr; } }
</style>
</head>
<body>

  <div class="container">
    <button class="back-btn" onclick="history.back()">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</button>

    <div class="lesson-wrapper">
      <div class="info-section">
        <div class="lesson-title" id="lessonTitle">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ --</div>
        <h1 id="lessonName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>
        <div id="lessonContent" style="color:#bbb; line-height:1.8; margin-bottom:20px;"></div>
        
        <div style="background:#1e1e1e; padding:15px; border-radius:8px; border:1px solid #333;">
           <div style="font-size:12px; color:#888; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;">Ù…Ø«Ø§Ù„ ØªÙˆØ¶ÙŠØ­ÙŠ</div>
           <pre style="direction:ltr;"><code id="exampleCode" class="language-python"></code></pre>
        </div>
      </div>

      <div class="editor-section">
        <h2 style="margin-bottom:15px; color:#dd8448;">ğŸ¯ Ù…Ù‡Ù…ØªÙƒ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©</h2>
        <div id="challengeDesc" style="background:#222; padding:15px; border-right:4px solid #dd8448; margin-bottom:20px; color:#eee;"></div>
        
        <div class="editor-container">
           <pre id="highlightingArea" class="editor-layer"><code id="highlightingCode"></code></pre>
           <textarea id="codeEditor" class="editor-layer" spellcheck="false" oninput="updateHighlighting(); syncScroll();" onscroll="syncScroll();"></textarea>
        </div>

        <div class="button-group">
          <button class="btn btn-run" onclick="runCode()">â–¶ ØªØ´ØºÙŠÙ„</button>
          <button id="victor" class="btn btn-check" onclick="vandc()">âœ“ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù„</button>
        </div>
        
        <div id="outputSection" class="output-section">Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</div>
        <div id="resultMessage" class="result-message"></div>
      </div>
    </div>
  </div>

  <script type="module">
    // --- Ø±Ø¨Ø· Firebase ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
    import { db } from '../chat/js/fb.js'; 
    import { ref, update, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¯Ø±ÙˆØ³ Ø§Ù„Ù„ØºØ§Øª
    import { python } from './js/python.js';
    import { javascript } from './js/javascript.js';
    import { java } from './js/java.js';
    import { cpp } from './js/cpp.js';

    window.lessons = { python, javascript, java, cpp };

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Firebase
    window.saveProgress = async function(currentLang, solvedLevel) {
        const deviceId = localStorage.getItem('device_id');
        if (!deviceId) return;

        try {
            const dbRef = ref(db);
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… deviceId
            const snapshot = await get(child(dbRef, `users`));
            
            if (snapshot.exists()) {
                const users = snapshot.val();
                const userKey = Object.keys(users).find(key => users[key].deviceId === deviceId);
                
                if (userKey) {
                    const userData = users[userKey];
                    const currentStoredLevel = userData[currentLang] || 0;

                    // Ø§Ù„Ù…Ù†Ø·Ù‚: Ù†Ø­Ø¯Ø« ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø°ÙŠ Ø­Ù„Ù‡ Ù‡Ùˆ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ Ø£Ùˆ Ø£ÙƒØ¨Ø±
                    if (solvedLevel > currentStoredLevel) {
                        await update(ref(db, `users/${userKey}`), {
                            [currentLang]: solvedLevel
                        });
                        console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙˆØ§Ùƒ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                    } else {
                        console.log("â„¹ï¸ Ø£Ù†Øª ØªØ±Ø§Ø¬Ø¹ Ù…Ø³ØªÙˆÙ‰ Ù‚Ø¯ÙŠÙ…ØŒ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                    }
                }
            }
        } catch (error) {
            console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Firebase:", error);
        }
    };

    if(window.initLesson) window.initLesson();
  </script>

  <script>
    let lang = 'python';
    let level = 1;
    let expectedOutput = "";
    let check = false;

    window.initLesson = function() {
        const urlParams = new URLSearchParams(window.location.search);
        lang = (urlParams.get('lang') || 'python').toLowerCase();
        level = parseInt(urlParams.get('level')) || 1; 
        loadLessonData();
    };

    function loadLessonData() {
        if (!window.lessons || !window.lessons[lang]) {
            setTimeout(loadLessonData, 100); 
            return;
        }

        const data = window.lessons[lang][level];
        if (!data) return;

        document.getElementById('lessonTitle').textContent = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${level}`;
        document.getElementById('lessonName').textContent = data.title;
        document.getElementById('lessonContent').innerHTML = data.description;
        document.getElementById('challengeDesc').textContent = data.challenge;
        
        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø«Ø§Ù„
        const exampleEl = document.getElementById('exampleCode');
        exampleEl.textContent = data.content ? data.content.replace(/<[^>]*>/g, '').trim() : "";
        exampleEl.className = `language-${lang}`;
        hljs.highlightElement(exampleEl);

        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø­Ø±Ø±
        expectedOutput = data.expectedOutput;
        document.getElementById('codeEditor').value = data.startCode || "";
        updateHighlighting();
        
    }

    function updateHighlighting() {
        const code = document.getElementById('codeEditor').value;
        const target = document.getElementById('highlightingCode');
        target.textContent = code + (code.endsWith('\n') ? ' ' : '');
        target.className = `language-${lang}`;
        hljs.highlightElement(target);
    }

    function syncScroll() {
        const editor = document.getElementById('codeEditor');
        const highlight = document.getElementById('highlightingArea');
        highlight.scrollTop = editor.scrollTop;
        highlight.scrollLeft = editor.scrollLeft;
    }

    async function runCode() {
        const code = document.getElementById('codeEditor').value;
        const outputBox = document.getElementById('outputSection');
        outputBox.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø­Ø±Ùƒ...";

        const langMap = {
            'python': { l: 'python', v: '3.10.0' },
            'javascript': { l: 'javascript', v: '18.15.0' },
            'java': { l: 'java', v: '15.0.2' },
            'cpp': { l: 'c++', v: '10.2.0' }
        };

        try {
            const res = await fetch('https://emkc.org/api/v2/piston/execute', {
                method: 'POST',
                body: JSON.stringify({
                    "language": langMap[lang].l,
                    "version": langMap[lang].v,
                    "files": [{"content": code}]
                })
            });
            const result = await res.json();
            const output = result.run.stdout || result.run.stderr || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø±Ø¬Ø§Øª";
            outputBox.textContent = output;
            return output.trim();
        } catch (e) {
            outputBox.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
            return null;
        }
    }
    
   
   function vandc() {
      if(check == true) {
       window.location.href = `levels.html`;
       
      } else {
       
        checkSolution();
      }
    }
   

  
    async function checkSolution() {
        const actual = await runCode();
        const msg = document.getElementById('resultMessage');
        const victor = document.getElementById('victor');
        msg.style.display = "block";

        
        if (actual === expectedOutput.trim()) {
         msg.className = "result-message success";
         msg.innerHTML = "ğŸ‰ Ø£Ø­Ø³Ù†Øª! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©.";
         check = true;
         victor.innerHTML = "Ø§Ù„ØªØ§Ù„ÙŠ â¡";

         if (window.saveProgress) {
            window.saveProgress(lang, level);
          }

        } else {
          msg.className = "result-message error";
          msg.innerHTML = `âŒ Ù„Ù… ØªØ¶Ø¨Ø· Ù…Ø¹Ùƒ Ø¨Ø¹Ø¯.<br><small>Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${expectedOutput}</small>`;
        }
    }
  </script>
</body>
</html>