<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“ Ø­Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± - Ishraq Step</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--accent:#4caf50; --danger:#f44336; --warning:#ff9800}
  *{box-sizing:border-box}
  body{font-family:'Cairo',sans-serif;margin:0;background:linear-gradient(135deg,#0b0b0d 0%,#071018 100%);color:#e8eef6;padding:0;direction:rtl}
  .exam-container{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 280px;gap:20px;padding:20px}
  
  .exam-main{background:#0f1113;border:1px solid rgba(255,255,255,0.05);border-radius:12px;padding:24px}
  .exam-sidebar{background:#0f1113;border:1px solid rgba(255,255,255,0.05);border-radius:12px;padding:16px;height:fit-content;position:sticky;top:20px}
  
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.1)}
  .header h1{margin:0;color:var(--accent);font-size:22px}
  .timer{font-size:18px;font-weight:700;padding:8px 16px;background:rgba(244,67,54,0.1);border-radius:8px;color:var(--danger)}
  .timer.warning{background:rgba(255,152,0,0.1);color:var(--warning)}
  
  .question-container{margin-bottom:32px;padding:20px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.08);border-radius:12px}
  .question-number{color:var(--accent);font-weight:700;font-size:14px;margin-bottom:8px}
  .question-text{font-size:18px;font-weight:600;margin:12px 0;color:#e8eef6}
  
  .choices{display:flex;flex-direction:column;gap:12px;margin-top:16px}
  .choice-btn{background:rgba(255,255,255,0.03);border:2px solid rgba(255,255,255,0.1);color:#e8eef6;padding:12px 16px;border-radius:10px;cursor:pointer;text-align:right;font-weight:500;transition:all .3s}
  .choice-btn:hover{background:rgba(76,175,80,0.1);border-color:var(--accent)}
  .choice-btn.selected{background:var(--accent);color:#08121a;border-color:var(--accent)}
  .choice-btn.correct{background:rgba(76,175,80,0.2);border-color:var(--accent)}
  .choice-btn.incorrect{background:rgba(244,67,54,0.2);border-color:var(--danger)}
  
  .nav-buttons{display:flex;gap:8px;margin-top:24px;justify-content:center}
  .btn{padding:10px 16px;border-radius:8px;border:none;cursor:pointer;font-weight:600;transition:all .3s}
  .btn-primary{background:var(--accent);color:#08121a}
  .btn-primary:hover{opacity:.9;transform:translateY(-2px)}
  .btn-danger{background:var(--danger);color:#fff}
  .btn-neutral{background:rgba(255,255,255,0.1);color:#e8eef6}
  .btn-neutral:hover{background:rgba(255,255,255,0.15)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  
  .sidebar-section{margin-bottom:16px}
  .sidebar-label{font-size:12px;font-weight:700;color:var(--accent);margin-bottom:8px;text-transform:uppercase}
  .questions-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;max-height:300px;overflow-y:auto}
  .q-indicator{width:100%;aspect-ratio:1;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px;font-weight:700;transition:all .2s}
  .q-indicator:hover{background:rgba(76,175,80,0.2)}
  .q-indicator.active{background:var(--accent);color:#08121a;border-color:var(--accent)}
  .q-indicator.answered{background:rgba(76,175,80,0.3);border-color:var(--accent)}
  
  .stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:16px;font-size:12px}
  .stat-item{background:rgba(255,255,255,0.05);padding:8px;border-radius:6px;text-align:center}
  .stat-label{color:#9aa3af;font-size:11px}
  .stat-value{color:var(--accent);font-weight:700;font-size:14px}
  
  /* Result Screen */
  .result-container{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:40px;text-align:center;margin:20px}
  .result-score{font-size:48px;font-weight:800;color:var(--accent);margin:20px 0}
  .result-message{font-size:20px;margin:20px 0;color:#e8eef6}
  .result-details{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin:30px 0}
  .result-stat{background:rgba(255,255,255,0.05);padding:16px;border-radius:10px}
  .result-stat-label{color:#9aa3af;font-size:14px;margin-bottom:8px}
  .result-stat-value{font-size:24px;font-weight:700;color:var(--accent)}
  
  .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;align-items:center;justify-content:center}
  .modal.show{display:flex}
  .modal-content{background:#0f1113;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:24px;max-width:600px;max-height:80vh;overflow-y:auto;color:#e8eef6}
  .modal-close{float:left;background:none;border:none;color:#e8eef6;font-size:24px;cursor:pointer}
  
  .review-item{background:rgba(255,255,255,0.05);padding:16px;border-radius:10px;margin-bottom:12px;border-right:4px solid rgba(255,255,255,0.1)}
  .review-item.wrong{border-right-color:var(--danger)}
  .review-q{font-weight:700;color:#e8eef6;margin-bottom:8px}
  .review-answer{font-size:14px;color:#9aa3af;margin:6px 0}
  .review-correct{color:var(--accent)}
  .review-incorrect{color:var(--danger)}
  
  @media(max-width:968px){
    .exam-container{grid-template-columns:1fr;gap:16px}
    .exam-sidebar{position:static}
    .questions-grid{grid-template-columns:repeat(6,1fr)}
  }
</style>
</head>
<body>
  <div class="exam-container" id="examContainer">
    <!-- Main Exam Area -->
    <div class="exam-main">
      <div class="header">
        <h1 id="examTitle">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</h1>
        <div class="timer" id="timer">00:00</div>
      </div>

      <div id="questionArea"></div>

      <div class="nav-buttons">
        <button class="btn btn-neutral" id="prevBtn" disabled>â¬…ï¸ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <button class="btn btn-primary" id="saveBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
        <button class="btn btn-neutral" id="nextBtn">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
      </div>

      <div style="margin-top:20px;display:flex;gap:8px;justify-content:center">
        <button class="btn btn-danger" id="submitBtn">ğŸ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
        <button class="btn btn-neutral" id="endTimeBtn">â¹ï¸ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª</button>
      </div>

      <!-- Result Screen (Hidden) -->
      <div id="resultScreen" style="display:none">
        <div class="result-container">
          <h2 style="color:var(--accent);margin-top:0">ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± âœ…</h2>
          <div class="result-score" id="scoreDisplay">0/0</div>
          <div class="result-message" id="resultMessage"></div>
          <div class="result-details">
            <div class="result-stat">
              <div class="result-stat-label">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</div>
              <div class="result-stat-value" id="correctCount">0</div>
            </div>
            <div class="result-stat">
              <div class="result-stat-label">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©</div>
              <div class="result-stat-value" id="wrongCount">0</div>
            </div>
            <div class="result-stat">
              <div class="result-stat-label">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</div>
              <div class="result-stat-value" id="percentage">0%</div>
            </div>
          </div>
          <div style="margin-top:24px;display:flex;gap:12px;justify-content:center">
            <button class="btn btn-primary" id="reviewBtn">ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©</button>
            <button class="btn btn-neutral" onclick="location.href='tests.html'">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="exam-sidebar">
      <div class="sidebar-section">
        <div class="sidebar-label">Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
        <div class="questions-grid" id="questionsGrid"></div>
      </div>
      
      <div class="sidebar-section stats">
        <div class="stat-item">
          <div class="stat-label">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</div>
          <div class="stat-value" id="answeredCount">0/0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</div>
          <div class="stat-value" id="remainingCount">0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Review Modal -->
  <div class="modal" id="reviewModal">
    <div class="modal-content">
      <button class="modal-close" onclick="document.getElementById('reviewModal').classList.remove('show')">&times;</button>
      <h2 style="margin-top:0;color:var(--accent)">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©</h2>
      <div id="reviewList"></div>
    </div>
  </div>

  <script type="module">
    import { db } from './chat/js/fb.js';
    import { ref, get, child } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // DOM Elements
    const examContainer = document.getElementById('examContainer');
    const examTitle = document.getElementById('examTitle');
    const timer = document.getElementById('timer');
    const questionArea = document.getElementById('questionArea');
    const prevBtn = document.getElementById('prevBtn');
    const saveBtn = document.getElementById('saveBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const endTimeBtn = document.getElementById('endTimeBtn');
    const questionsGrid = document.getElementById('questionsGrid');
    const resultScreen = document.getElementById('resultScreen');
    const reviewModal = document.getElementById('reviewModal');
    const reviewList = document.getElementById('reviewList');

    let testData = null;
    let questions = [];
    let currentQuestionIndex = 0;
    let userAnswers = {};
    let timeLeft = 0;
    let timerInterval = null;
    let isSubmitted = false;

    // Get test ID from URL
    const testId = new URLSearchParams(location.search).get('id');
    if (!testId) {
      examContainer.innerHTML = '<div style="color:var(--danger);padding:20px">Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>';
    } else {
      loadTest();
    }

    async function loadTest(){
      try{
        const snap = await get(child(ref(db), `tests/${testId}`));
        if(!snap.exists()){
          examContainer.innerHTML = '<div style="color:var(--danger);padding:20px">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>';
          return;
        }
        testData = snap.val();
        examTitle.textContent = testData.title || 'Ø§Ø®ØªØ¨Ø§Ø±';
        
        // Parse questions from PDF (ÙŠÙ…ÙƒÙ† ØªØ®Ø²ÙŠÙ†Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Firebase)
        // Ù„Ù„Ø¢Ù† Ø³Ù†Ø³ØªØ®Ø¯Ù… Ù†Ù…ÙˆØ°Ø¬ ØªØ¬Ø±ÙŠØ¨ÙŠ
        questions = generateMockQuestions(10);
        
        // Set timer (duration in minutes)
        timeLeft = (testData.duration || 60) * 60; // Convert to seconds
        startTimer();
        renderQuestion();
        renderQuestionsGrid();
        updateStats();
      }catch(err){
        console.error(err);
        examContainer.innerHTML = '<div style="color:var(--danger);padding:20px">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>';
      }
    }

    function generateMockQuestions(count){
      // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØ¹Ù„ÙŠØŒ Ø³ØªØ£ØªÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ù…Ù„Ù PDF Ù…Ø­Ù„Ù„
      return Array.from({length:count}, (_, i)=>({
        id: i+1,
        text: `Ø§Ù„Ø³Ø¤Ø§Ù„ ${i+1}: Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©ØŸ`,
        choices: [
          {text:'Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„', correct:i%2===0},
          {text:'Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ', correct:i%2!==0},
          {text:'Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«', correct:false},
          {text:'Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹', correct:false}
        ]
      }));
    }

    function startTimer(){
      timer.textContent = formatTime(timeLeft);
      timerInterval = setInterval(()=>{
        timeLeft--;
        timer.textContent = formatTime(timeLeft);
        
        if(timeLeft <= 300) timer.classList.add('warning');
        if(timeLeft <= 0){
          clearInterval(timerInterval);
          submitTest();
        }
      }, 1000);
    }

    function formatTime(seconds){
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function renderQuestion(){
      if(currentQuestionIndex < 0 || currentQuestionIndex >= questions.length) return;
      
      const q = questions[currentQuestionIndex];
      const saved = userAnswers[currentQuestionIndex];
      
      questionArea.innerHTML = `
        <div class="question-container">
          <div class="question-number">Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIndex+1} Ù…Ù† ${questions.length}</div>
          <div class="question-text">${escapeHtml(q.text)}</div>
          <div class="choices">
            ${q.choices.map((c, i)=>`
              <button class="choice-btn ${saved === i ? 'selected' : ''}" 
                onclick="selectAnswer(${i})" 
                ${isSubmitted ? (c.correct ? 'class="choice-btn correct"' : (saved === i ? 'class="choice-btn incorrect"' : '')) : ''}>
                ${String.fromCharCode(65+i)}: ${escapeHtml(c.text)}
              </button>
            `).join('')}
          </div>
        </div>
      `;
      
      prevBtn.disabled = currentQuestionIndex === 0;
      nextBtn.disabled = currentQuestionIndex === questions.length - 1;
      updateStats();
      questionsGrid.querySelectorAll('.q-indicator').forEach((el,i)=>{
        el.classList.toggle('active', i === currentQuestionIndex);
      });
    }

    window.selectAnswer = function(choiceIndex){
      if(isSubmitted) return;
      userAnswers[currentQuestionIndex] = choiceIndex;
      updateStats();
      questionsGrid.querySelector(`[data-q="${currentQuestionIndex}"]`).classList.add('answered');
    };

    function renderQuestionsGrid(){
      questionsGrid.innerHTML = questions.map((q, i)=>`
        <div class="q-indicator ${i === currentQuestionIndex ? 'active' : ''} ${userAnswers[i] !== undefined ? 'answered' : ''}" 
          data-q="${i}" 
          onclick="goToQuestion(${i})">
          ${i+1}
        </div>
      `).join('');
    }

    window.goToQuestion = function(index){
      currentQuestionIndex = index;
      renderQuestion();
    };

    saveBtn.addEventListener('click', ()=>{
      const message = userAnswers[currentQuestionIndex] !== undefined ? 
        'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©' : 'âš ï¸ Ù„Ù… ØªØ®ØªØ± Ø¥Ø¬Ø§Ø¨Ø©';
      alert(message);
    });

    prevBtn.addEventListener('click', ()=>{
      if(currentQuestionIndex > 0){
        currentQuestionIndex--;
        renderQuestion();
      }
    });

    nextBtn.addEventListener('click', ()=>{
      if(currentQuestionIndex < questions.length - 1){
        currentQuestionIndex++;
        renderQuestion();
      }
    });

    submitBtn.addEventListener('click', ()=>{
      if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ….')){
        submitTest();
      }
    });

    endTimeBtn.addEventListener('click', ()=>{
      if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª ÙˆØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†ØŸ')){
        timeLeft = 0;
        submitTest();
      }
    });

    function submitTest(){
      clearInterval(timerInterval);
      isSubmitted = true;
      
      // Calculate results
      let correct = 0;
      let wrong = 0;
      const wrongAnswers = [];
      
      questions.forEach((q, i)=>{
        const userChoice = userAnswers[i];
        if(userChoice === undefined){
          wrong++;
        } else if(q.choices[userChoice].correct){
          correct++;
        } else {
          wrong++;
          wrongAnswers.push({question: q, userChoice, correctChoice: q.choices.findIndex(c=>c.correct)});
        }
      });
      
      const percentage = Math.round((correct / questions.length) * 100);
      const score = correct;
      const maxScore = questions.length;
      
      // Show result
      document.getElementById('scoreDisplay').textContent = `${score}/${maxScore}`;
      document.getElementById('correctCount').textContent = correct;
      document.getElementById('wrongCount').textContent = wrong;
      document.getElementById('percentage').textContent = `${percentage}%`;
      document.getElementById('resultMessage').textContent = 
        percentage >= 80 ? 'ğŸ‰ Ù…Ù…ØªØ§Ø²!' : 
        percentage >= 60 ? 'ğŸ‘ Ø¬ÙŠØ¯' : 'ğŸ“š ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†';
      
      document.getElementById('reviewBtn').onclick = ()=>{
        showReview(wrongAnswers);
      };
      
      // Re-render questions with correct/incorrect styling
      renderQuestion();
      document.querySelector('.exam-main').style.display = 'none';
      resultScreen.style.display = 'block';
    }

    function showReview(wrongAnswers){
      reviewList.innerHTML = wrongAnswers.map(item=>`
        <div class="review-item wrong">
          <div class="review-q">${escapeHtml(item.question.text)}</div>
          <div class="review-answer">
            Ø¥Ø¬Ø§Ø¨ØªÙƒ: <span class="review-incorrect">${escapeHtml(item.question.choices[item.userChoice].text)}</span>
          </div>
          <div class="review-answer">
            Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: <span class="review-correct">${escapeHtml(item.question.choices[item.correctChoice].text)}</span>
          </div>
        </div>
      `).join('') || '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø®Ø§Ø·Ø¦Ø©! ğŸ‰</div>';
      reviewModal.classList.add('show');
    }

    function updateStats(){
      const answered = Object.keys(userAnswers).length;
      document.getElementById('answeredCount').textContent = `${answered}/${questions.length}`;
      document.getElementById('remainingCount').textContent = questions.length - answered;
    }

    function escapeHtml(s){
      return (s||'').toString()
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;');
    }
  </script>
</body>
</html>