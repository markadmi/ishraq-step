<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª - Ishraq Step</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--accent:#4caf50}
  body{font-family:'Cairo',sans-serif;margin:0;background:linear-gradient(135deg,#0b0b0d 0%,#071018 100%);color:#e8eef6;padding:28px;direction:rtl}
  header{font-weight:800;color:var(--accent);text-align:center;font-size:20px;margin-bottom:18px}
  .container{max-width:1100px;margin:0 auto}
  .sections{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
  .section-card{background:linear-gradient(135deg,var(--accent),#00bcd4);color:#fff;padding:16px;border-radius:12px;text-align:center;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,.4)}
  .loader{display:flex;gap:10px;align-items:center;justify-content:center;padding:12px;background:#fff;color:#333;border-radius:10px;margin:12px 0}
  .spinner{width:18px;height:18px;border:3px solid #ddd;border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  #tests-list{margin-top:14px}
  .test-item{background:#0f1113;border:1px solid rgba(255,255,255,0.03);padding:12px;border-radius:10px;margin-bottom:10px;display:flex;gap:12px;align-items:flex-start}
  .test-meta{flex:1}
  .test-meta h3{margin:0 0 6px 0;color:#ffd166;font-size:18px}
  .test-meta p{margin:0;color:#af9aa8}
  .back{display:inline-block;margin:12px 0;padding:8px 12px;background:#fff;color:var(--accent);border-radius:8px;text-decoration:none}
  .muted{color:#9aa3af;font-size:13px}
</style>

  <link rel="stylesheet" href="css/open-sidebar.css">
</head>
<body>
  
  <input type="checkbox" id="toggleSidebar">
 <label for="toggleSidebar" class="toggle-btn">
  â˜° Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
 </label>
 
 <iframe id="siteSidebar" src="sidebar.html"></iframe>

  <div class="container">
    <header>ğŸ“ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ishraq Step</header>

    <div id="loader" class="loader" style="display:none"><div class="spinner" aria-hidden="true"></div><div>Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>

    <h2 class="muted" id="sections-title">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
    <div id="sections" class="sections"></div>

    <div id="tests-view" style="display:none">
      <a id="backBtn" class="back" href="#">â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø£Ù‚Ø³Ø§Ù…</a>
      <h2 id="subjectTitle" style="color:var(--accent)"></h2>
      <div id="tests-list"></div>
    </div>

    <div id="empty" class="muted" style="display:none;text-align:center;margin-top:18px">Ù„Ù… ØªÙØ¶Ø§Ù Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯.</div>
  </div>

  <script type="module">
    import { db } from './chat/js/fb.js';
    import { ref, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const loader = document.getElementById('loader');
    const sectionsEl = document.getElementById('sections');
    const testsView = document.getElementById('tests-view');
    const testsList = document.getElementById('tests-list');
    const backBtn = document.getElementById('backBtn');
    const subjectTitle = document.getElementById('subjectTitle');
    const emptyEl = document.getElementById('empty');

    const TESTS_PATH = 'tests';
    const testsRef = ref(db, TESTS_PATH);

    function showLoader(show){ loader.style.display = show ? 'flex' : 'none'; }

    onValue(testsRef, snapshot=>{
      showLoader(true);
      const data = snapshot.val() || {};
      const arr = Object.values(data);
      if(arr.length === 0){
        sectionsEl.innerHTML = '';
        testsList.innerHTML = '';
        testsView.style.display = 'none';
        emptyEl.style.display = 'block';
        showLoader(false);
        return;
      }
      emptyEl.style.display = 'none';

      // Ø¬Ù…Ø¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (subjects)
      const subjects = Array.from(new Set(arr.map(i => (i.subject||'Ø¹Ø§Ù…').trim()))).filter(Boolean);
      sectionsEl.innerHTML = '';
      subjects.forEach(s=>{
        const d = document.createElement('div');
        d.className = 'section-card';
        d.textContent = s || 'Ø¹Ø§Ù…';
        d.addEventListener('click', ()=> showTestsForSubject(s));
        sectionsEl.appendChild(d);
      });

      showLoader(false);
    }, err=>{
      console.error(err);
      showLoader(false);
      sectionsEl.innerHTML = '<div class="muted">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>';
    });

    function showTestsForSubject(subject){
      subjectTitle.textContent = subject;
      testsList.innerHTML = '';
      testsView.style.display = 'block';
      sectionsEl.scrollIntoView({behavior:'smooth'});
      showLoader(true);

      // Ù‚Ø±Ø§Ø¡Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ù† DB
      onValue(testsRef, snapshot=>{
        const data = snapshot.val() || {};
        const arr = Object.entries(data)
          .filter(([k,v]) => ((v.subject||'').trim() || 'Ø¹Ø§Ù…') === (subject || 'Ø¹Ø§Ù…'))
          .sort((a,b)=> new Date(b[1].createdAt||0) - new Date(a[1].createdAt||0));
        if(arr.length === 0){
          testsList.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù….</div>';
          showLoader(false);
          return;
        }
        testsList.innerHTML = '';
        arr.forEach(([id, item])=>{
          const div = document.createElement('div');
          div.className = 'test-item';
          div.innerHTML = `
            <div class="test-meta">
              <h3>${escapeHtml(item.title||'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†')}</h3>
              <p>${escapeHtml(item.description||'')}</p>
              <div class="muted" style="margin-top:8px">Ø§Ù„Ø¯Ø±Ø¬Ø©: ${escapeHtml(String(item.maxScore||'â€”'))} â€¢ Ø§Ù„Ù…Ø¯Ø©: ${escapeHtml(String(item.duration||'â€”'))} Ø¯Ù‚Ø§Ø¦Ù‚</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <a href="test.html?id=${encodeURIComponent(id)}" style="background:#fff;color:var(--accent);padding:8px 10px;border-radius:8px;text-decoration:none;font-weight:700">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø®ØªØ¨Ø§Ø±</a>
              ${ item.fileUrl ? `<a href="${escapeAttr(item.fileUrl)}" target="_blank" style="background:#222;color:#fff;padding:8px 10px;border-radius:8px;text-decoration:none">ÙØªØ­ Ø§Ù„Ù…Ù„Ù</a>` : '' }
            </div>
          `;
          testsList.appendChild(div);
        });
        showLoader(false);
      }, err=>{
        testsList.innerHTML = '<div class="muted">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</div>';
        console.error(err);
        showLoader(false);
      }, { onlyOnce: true });
    }

    backBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      testsView.style.display = 'none';
      sectionsEl.scrollIntoView({behavior:'smooth'});
    });

    function escapeHtml(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function escapeAttr(s){ return (s||'').toString().replaceAll('"','%22'); }
  </script>
   
 <iframe src="sidebar.html" id="siteSidebar" title="Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø§Ù†Ø¨ÙŠØ© â€” Ishraq Step"></iframe>
</body>
</html>