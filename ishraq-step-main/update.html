<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ›ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª (Firebase)</title>
<style>
  body{font-family:Cairo, sans-serif; background: linear-gradient(135deg,#4caf50,#00bcd4); margin:0; padding:20px; color:#333; direction:rtl}
  h1{text-align:center;color:white}
  .form{background:white;padding:15px;border-radius:12px;max-width:500px;margin:20px auto;box-shadow:0 4px 15px rgba(0,0,0,0.2)}
  label{display:block;margin-top:10px;font-weight:bold}
  input,textarea,select{width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:6px}
  button{background:linear-gradient(90deg,#4caf50,#00bcd4);color:white;border:none;padding:10px;margin-top:15px;width:100%;border-radius:8px;cursor:pointer;font-size:16px}
  button:hover{opacity:.95}
  .sections{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-top:20px}
  .section-card{background:linear-gradient(135deg,#4caf50,#00eeff);color:white;border-radius:14px;text-align:center;padding:14px;cursor:pointer;transition:transform .25s}
  .section-card:hover{transform:scale(1.05)}
  .videos-list{margin-top:20px}
  .video-item{background:white;border-radius:10px;padding:10px;margin-bottom:10px;box-shadow:0 2px 6px rgba(0,0,0,.2)}
  .video-item iframe{width:100%;border-radius:10px}
  .edit-btn{background:#ff9800;border:none;padding:5px 8px;border-radius:6px;cursor:pointer;color:white;margin-top:5px}
</style>
</head>
<body>

<h1>ğŸ›ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª (Firebase)</h1>

<div class="form">
  <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
  <input id="title" type="text">

  <label>Ø§Ù„ÙˆØµÙ:</label>
  <textarea id="description"></textarea>

  <label>Ø±Ø§Ø¨Ø· YouTube (Ø£Ùˆ ID Ø£Ùˆ iframe):</label>
  <input id="url" type="text" placeholder="https://www.youtube.com/watch?v=XXXXXXX Ø£Ùˆ ÙÙ‚Ø· Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø£Ùˆ iframe">

  <label>Ø§Ù„Ù‚Ø³Ù…:</label>
  <select id="type">
    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
    <option value="Ù…Ø§Ø« 0">ğŸ§® Ù…Ø§Ø« 0</option>
    <option value="Ù…Ø§Ø« 1">ğŸ§® Ù…Ø§Ø« 1</option>
    <option value="Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ">ğŸ‡¬ğŸ‡§ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</option>
    <option value="Ø¯ÙˆØ§Ø¦Ø± ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©">ğŸ”Œ Ø¯ÙˆØ§Ø¦Ø± ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</option>
    <option value="Ø§Ø®Ù„Ø§Ù‚ÙŠØ§Øª Ø§Ù„Ù…Ù‡Ù†Ù‡">âš–ï¸ Ø£Ø®Ù„Ø§Ù‚ÙŠØ§Øª Ø§Ù„Ù…Ù‡Ù†Ø©</option>
    <option value="Ù…Ù‚Ø¯Ù…Ø© Ø­Ø§Ø³Ø¨ Ø§Ù„ÙŠ">ğŸ’» Ù…Ù‚Ø¯Ù…Ø© Ø­Ø§Ø³Ø¨ Ø¢Ù„ÙŠ</option>
    <option value="ÙÙŠØ²ÙŠØ§Ø¡">ğŸ§² ÙÙŠØ²ÙŠØ§Ø¡</option>
  </select>

  <button id="addBtn">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙÙ‡Ø±Ø³</button>
</div>

<h2 style="color:white;">ğŸ“š Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
<div id="sections-container" class="sections"></div>

<div id="videos-container" class="videos-list"></div>

<script type="module">
  import { db } from './chat/js/fb.js';
  import { ref, push, set, onValue, update as dbUpdate } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  const titleInput = document.getElementById('title');
  const descInput = document.getElementById('description');
  const urlInput = document.getElementById('url');
  const typeSelect = document.getElementById('type');
  const addBtn = document.getElementById('addBtn');
  const sectionsContainer = document.getElementById('sections-container');
  const videosContainer = document.getElementById('videos-container');

  let jsonData = {}; // Ù…Ø­Ù„ÙŠ Ù…Ø¤Ù‚Øª ÙŠÙØ¨Ù†Ù‰ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Firebase
  const sections = ["Ù…Ø§Ø« 0","Ù…Ø§Ø« 1","Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ","Ø¯ÙˆØ§Ø¦Ø± ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©","Ø§Ø®Ù„Ø§Ù‚ÙŠØ§Øª Ø§Ù„Ù…Ù‡Ù†Ù‡","Ù…Ù‚Ø¯Ù…Ø© Ø­Ø§Ø³Ø¨ Ø§Ù„ÙŠ","ÙÙŠØ²ÙŠØ§Ø¡"];

  let editMode = false;
  let editId = null;
  let editSection = null;

  function initSections(){
    sectionsContainer.innerHTML = '';
    sections.forEach(type=>{
      if(!jsonData[type]) jsonData[type] = {};
      const card = document.createElement('div');
      card.className = 'section-card';
      card.textContent = type;
      card.addEventListener('click', ()=>showSection(type));
      sectionsContainer.appendChild(card);
    });
  }

  initSections();

  // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Firebase Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± 'courses'
  const coursesRef = ref(db, 'courses');
  onValue(coursesRef, snapshot=>{
    const flat = snapshot.val() || {};
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
    jsonData = {};
    sections.forEach(s => jsonData[s] = {});
    for(const id in flat){
      const item = flat[id];
      if(!item.type) item.type = sections[0];
      if(!jsonData[item.type]) jsonData[item.type] = {};
      jsonData[item.type][id] = item;
    }
    initSections();
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‚Ø³Ù… Ù…Ø­Ø¯Ø¯ Ø¸Ø§Ù‡Ø±ØŒ Ø£Ø¹Ø¯ Ø¹Ø±Ø¶Ù‡ (Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªØ­ØªÙØ¸ Ø¨Ù‡ Ø¹Ø±Ø¶ Ø¢Ø®Ø±)
    const visible = document.querySelector('.section-card.active');
    if(visible) showSection(visible.textContent);
  });

  addBtn.addEventListener('click', async (e)=>{
    e.preventDefault();
    const title = titleInput.value.trim();
    const description = descInput.value.trim();
    const raw = urlInput.value.trim();
    const url = convertUrl(raw);
    const type = typeSelect.value;

    if(!title || !description || !url || !type){
      alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
      return;
    }

    if(editMode && editId){
      const video = { title, description, url, type, id: editId };
      // ØªØ­Ø¯ÙŠØ« ÙÙŠ Firebase
      await set(ref(db, `courses/${editId}`), video);
      editMode = false;
      editId = null;
      editSection = null;
      addBtn.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙÙ‡Ø±Ø³';
      alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
    } else {
      const newRef = push(coursesRef);
      const id = newRef.key;
      const video = { title, description, url, type, id };
      await set(newRef, video);
      alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ');
    }

    clearForm();
    showSection(type);
  });

  function convertUrl(link){
    if(!link) return '';
    const iframeMatch = link.match(/src\s*=\s*["']([^"']+)["']/i);
    if(iframeMatch) return iframeMatch[1].split('?')[0];
    if(link.includes('youtube.com/embed/')) return link.split('?')[0];
    if(/^[A-Za-z0-9_-]{11}$/.test(link)) return `https://www.youtube.com/embed/${link}`;
    let m = link.match(/[?&]v=([^&]+)/);
    if(m) return `https://www.youtube.com/embed/${m[1]}`;
    m = link.match(/youtu\.be\/([^?&]+)/);
    if(m) return `https://www.youtube.com/embed/${m[1]}`;
    m = link.match(/embed\/([^?&]+)/);
    if(m) return `https://www.youtube.com/embed/${m[1]}`;
    m = link.match(/([A-Za-z0-9_-]{11})$/);
    if(m) return `https://www.youtube.com/embed/${m[1]}`;
    return '';
  }

  function clearForm(){
    titleInput.value='';
    descInput.value='';
    urlInput.value='';
    typeSelect.value='';
  }

  function showSection(type){
    // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
    document.querySelectorAll('.section-card').forEach(c=>{ c.classList.remove('active'); if(c.textContent===type) c.classList.add('active'); });
    videosContainer.innerHTML = '';
    const section = jsonData[type];
    if(!section || Object.keys(section).length===0){
      videosContainer.innerHTML = '<p style="color:white;">ğŸš§ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ø¶Ø§ÙØ©</p>';
      return;
    }
    Object.values(section).forEach(video=>{
      const div = document.createElement('div');
      div.className = 'video-item';
      div.innerHTML = `
        <iframe src="${escapeHtml(video.url)}" allowfullscreen></iframe>
        <h3>${escapeHtml(video.title)}</h3>
        <p>${escapeHtml(video.description)}</p>
        <button class="edit-btn" data-type="${escapeHtml(video.type)}" data-id="${escapeHtml(video.id)}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
      `;
      const btn = div.querySelector('.edit-btn');
      btn.addEventListener('click', ()=> editVideo(video.type, video.id));
      videosContainer.appendChild(div);
    });
  }

  function editVideo(type, id){
    const video = jsonData[type] && jsonData[type][id];
    if(!video) { alert('âš ï¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
    titleInput.value = video.title;
    descInput.value = video.description;
    urlInput.value = video.url;
    typeSelect.value = video.type;
    editMode = true;
    editSection = type;
    editId = id;
    addBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function escapeHtml(s){
    return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

</script>
</body>
</html>
