<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style/owner.css">
</head>
<body>
  <div class="owner-container">
    <div class="owner-card">
      <h1>ğŸ‘‘ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³</h1>
      <p>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ§Ø±ÙØ¹ ØµÙˆØ±ØªÙƒ Ù„ØªØ¨Ø¯Ø£ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.</p>

      <label>Ø§Ù„Ø§Ø³Ù…</label>
      <input id="ownerName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³">

      <label>ØµÙˆØ±ØªÙƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input id="ownerAvatar" type="file" accept="image/*">

      <button id="enterOwner" class="btn">Ø¯Ø®ÙˆÙ„ ÙƒØ±Ø¦ÙŠØ³</button>

      <div id="info" class="info"></div>
    </div>
  </div>

  <script type="module" src="js/fb.js"></script>
  <script type="module">
    import { db, storage } from './js/fb.js';
    import { ref as dbRef, push, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { ref as storageRef, uploadString, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    const nameEl = document.getElementById('ownerName');
    const avatarEl = document.getElementById('ownerAvatar');
    const btn = document.getElementById('enterOwner');
    const info = document.getElementById('info');

    function setInfo(txt) { info.innerText = txt; }

    btn.addEventListener('click', async () => {
      const name = nameEl.value.trim();
      const file = avatarEl.files[0];

      if (!name) return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù….');

      setInfo('Ø¬Ø§Ø±Ù ØªØ¬Ù‡ÙŠØ² Ø­Ø³Ø§Ø¨Ùƒ...');

      let avatarUrl = 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png'; // ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      try {
        if (file) {
          const reader = new FileReader();
          reader.onload = async (e) => {
            const dataUrl = e.target.result;
            const path = `owners/${Date.now()}.png`;
            const sRef = storageRef(storage, path);
            await uploadString(sRef, dataUrl, 'data_url');
            avatarUrl = await getDownloadURL(sRef);
            await saveOwner(name, avatarUrl);
          };
          reader.readAsDataURL(file);
        } else {
          await saveOwner(name, avatarUrl);
        }
      } catch (err) {
        console.error(err);
        setInfo('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯Ø®ÙˆÙ„');
      }
    });

    async function saveOwner(name, avatarUrl) {
      const userRef = push(dbRef(db, 'owners'));
      await set(userRef, {
        name,
        avatarUrl,
        role: 'Ø±Ø¦ÙŠØ³',
        joinedAt: Date.now()
      });

      const session = {
        userKey: userRef.key,
        name,
        avatarUrl,
        role: 'Ø±Ø¦ÙŠØ³'
      };
      localStorage.setItem('chat_session', JSON.stringify(session));
      window.location.href = 'owner-chat.html';
    }

    // Ù„Ùˆ Ø¬Ù„Ø³Ø© Ø±Ø¦ÙŠØ³ Ù…ÙˆØ¬ÙˆØ¯Ø©
    const s = localStorage.getItem('chat_session');
    if (s) {
      const sess = JSON.parse(s);
      if (sess.role === 'Ø±Ø¦ÙŠØ³') {
        window.location.href = 'owner-chat.html';
      }
    }
  </script>
</body>
</html>
