<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ ğŸ‘‘</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style/owner-chat.css">
</head>
<body>
  <header class="top-bar">
    <div class="profile">
      <img id="ownerAvatar" src="" alt="avatar">
      <span id="ownerName">Ø§Ù„Ø±Ø¦ÙŠØ³</span>
    </div>
    <div class="controls">
      <button id="toggleChatBtn" class="btn danger">ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</button>
      <button id="clearAllBtn" class="btn danger">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      <button id="logoutBtn" class="btn">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <main id="chatContainer" class="chat-container"></main>

  <script type="module" src="js/fb.js"></script>
  <script type="module">
    import { db } from './js/fb.js';
    import { ref as dbRef, onChildAdded, onChildRemoved, remove, update, set, get } 
      from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const chatContainer = document.getElementById('chatContainer');
    const toggleChatBtn = document.getElementById('toggleChatBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const ownerAvatar = document.getElementById('ownerAvatar');
    const ownerName = document.getElementById('ownerName');

    let chatOpen = true;
    const session = JSON.parse(localStorage.getItem('chat_session') || '{}');
    if (!session || session.role !== 'Ø±Ø¦ÙŠØ³') {
      alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„');
      window.location.href = 'index.html';
    }

    ownerAvatar.src = session.avatarUrl || 'icon.png';
    ownerName.textContent = `${session.name} ğŸ‘‘`;

    // ğŸ”„ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    const chatStatusRef = dbRef(db, 'chat_status');
    async function loadChatStatus() {
      const snap = await get(chatStatusRef);
      if (snap.exists()) {
        chatOpen = snap.val().open;
        updateChatButton();
      } else {
        await set(chatStatusRef, { open: true });
      }
    }
    loadChatStatus();

    function updateChatButton() {
      toggleChatBtn.textContent = chatOpen ? 'ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©' : 'ğŸ”“ ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©';
      toggleChatBtn.classList.toggle('danger', chatOpen);
      toggleChatBtn.classList.toggle('success', !chatOpen);
    }

    toggleChatBtn.addEventListener('click', async () => {
      chatOpen = !chatOpen;
      await set(chatStatusRef, { open: chatOpen });
      updateChatButton();
      alert(chatOpen ? 'âœ… ØªÙ… ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©' : 'â›” ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§');
    });

    // ğŸšª Ø®Ø±ÙˆØ¬
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('chat_session');
      window.location.href = 'owner.html';
    });

    // ğŸ’¬ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    const messagesRef = dbRef(db, 'messages');
    onChildAdded(messagesRef, (snap) => {
      const msg = snap.val();
      addMessage(snap.key, msg);
    });

    onChildRemoved(messagesRef, (snap) => {
      const el = document.getElementById(`msg-${snap.key}`);
      if (el) el.remove();
    });

    function addMessage(id, msg) {
      const div = document.createElement('div');
      div.className = 'message';
      div.id = `msg-${id}`;
      div.innerHTML = `
        <img src="${msg.avatar}" class="avatar">
        <div class="content">
          <div class="meta">
            <strong>${msg.name}</strong> <span class="role">${msg.role}</span>
          </div>
          <div class="text">${msg.text}</div>
          <div class="actions">
            <button onclick="deleteMessage('${id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            <button onclick="banUser('${msg.deviceId || ''}', '${msg.name}')">ğŸš« Ø­Ø¸Ø±</button>
          </div>
        </div>
      `;
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // ğŸ—‘ï¸ Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø©
    window.deleteMessage = async function(id) {
      if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) {
        await remove(dbRef(db, `messages/${id}`));
      }
    };

    // ğŸš« Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…
    window.banUser = async function(deviceId, userName) {
      if (!deviceId) return alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø±Ù)');
      if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø¸Ø± ${userName}ØŸ`)) {
        await set(dbRef(db, `bans/${deviceId}`), {
          name: userName,
          timestamp: Date.now()
        });
        alert(`${userName} ØªÙ… Ø­Ø¸Ø±Ù‡ âœ…`);
      }
    };

    // ğŸ§¹ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
    clearAllBtn.addEventListener('click', async () => {
      if (confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŸ')) {
        await set(messagesRef, null);
        alert('âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ù†Ø¬Ø§Ø­');
      }
    });
  </script>
</body>
</html>
