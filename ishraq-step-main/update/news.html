<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ“° Ù†Ø´Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø± - Ishraq Step</title>
<style>
  body{font-family:Cairo, sans-serif; background: linear-gradient(135deg,#4caf50,#00bcd4); margin:0; padding:20px; color:#333; direction:rtl}
  h1{text-align:center;color:white; margin-bottom:40px}
  
  .nav-buttons{display:flex; gap:10px; justify-content:center; margin-bottom:30px; flex-wrap:wrap}
  .nav-btn{background:#fff; color:#4caf50; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600; transition:all .3s}
  .nav-btn:hover{transform:scale(1.05); box-shadow:0 5px 15px rgba(0,0,0,0.2)}
  
  .form{background:white;padding:15px;border-radius:12px;max-width:500px;margin:20px auto;box-shadow:0 4px 15px rgba(0,0,0,0.2)}
  label{display:block;margin-top:10px;font-weight:bold}
  input,textarea{width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:6px; box-sizing:border-box; font-family:Cairo, sans-serif}
  button{background:linear-gradient(90deg,#4caf50,#00bcd4);color:white;border:none;padding:10px;margin-top:15px;width:100%;border-radius:8px;cursor:pointer;font-size:16px; font-weight:600}
  button:hover{opacity:.95}
  
  .news-list{margin-top:20px}
  .news-item{background:white;border-radius:10px;padding:15px;margin-bottom:10px;box-shadow:0 2px 6px rgba(0,0,0,.2)}
  .news-item h3{margin:0 0 10px 0;color:#333}
  .news-item img{width:100%; border-radius:8px; margin:10px 0;max-height:300px;object-fit:cover}
  .news-item p{margin:8px 0;color:#555;line-height:1.6}
  .delete-btn{background:#f44336;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;color:white;margin-top:10px;font-weight:600}
  .delete-btn:hover{opacity:.9}
  .small{font-size:12px;color:#888;margin-top:6px}
  .progress{height:8px;background:#eee;border-radius:6px;overflow:hidden;margin-top:8px;display:none}
  .progress > span{display:block;height:100%;background:linear-gradient(90deg,#4caf50,#00bcd4);width:0%;transition:width .3s}
  .status{text-align:center;color:white;margin:10px 0;font-weight:600}
</style>
</head>
<body>

<h1>ğŸ“° Ù†Ø´Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ÙˆØ§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</h1>

<div class="nav-buttons">
  <button class="nav-btn" onclick="location.href='courses.html'">ğŸ“¹ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</button>
  <button class="nav-btn" onclick="location.href='books.html'">ğŸ“˜ Ø§Ù„ÙƒØªØ¨</button>
  <button class="nav-btn" style="background:#4caf50; color:white;">ğŸ“° Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</button>
  <button class="nav-btn" onclick="location.href='../index.html'">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
</div>

<div class="form">
  <h2 style="text-align:center;color:#333;margin-top:0">Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯</h2>
  
  <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ±:</label>
  <input id="post-title" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø¬Ø°Ø§Ø¨">

  <label>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ±:</label>
  <textarea id="post-content" placeholder="Ø§ÙƒØªØ¨ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù‡Ù†Ø§..."></textarea>

  <label>Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ø´Ø±:</label>
  <input id="post-author" type="text" placeholder="Ø§Ø³Ù…Ùƒ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚" value="Ishraq Step">

  <label>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
  <input id="post-image" type="file" accept="image/*">

  <div class="progress" id="upload-progress"><span></span></div>

  <button id="addPostBtn">ğŸ“¢ Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>
</div>

<div id="posts-container" class="news-list"></div>

<script type="module">
  import { db } from '../chat/js/fb.js';
  import { ref as dbRef, push, set, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
  import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

  // Ù…ÙØªØ§Ø­ Firebase Ù…ÙˆØ­Ø¯
  const POSTS_PATH = 'posts';

  const postTitleInput = document.getElementById('post-title');
  const postContentInput = document.getElementById('post-content');
  const postAuthorInput = document.getElementById('post-author');
  const postImageInput = document.getElementById('post-image');
  const addPostBtn = document.getElementById('addPostBtn');
  const postsContainer = document.getElementById('posts-container');
  const uploadProgress = document.getElementById('upload-progress');
  const progressBar = uploadProgress.querySelector('span');

  let postsData = {};
  const storage = getStorage();
  const postsRef = dbRef(db, POSTS_PATH);

  // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù…Ù† Firebase
  onValue(postsRef, (snapshot) => {
    postsData = snapshot.val() || {};
    renderPosts();
  }, (error) => {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
    postsContainer.innerHTML = '<p style="color:white;text-align:center">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</p>';
  });

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) return 'Ø§Ù„Ø¢Ù†';
    if (diff < 3600000) return 'Ù‚Ø¨Ù„ ' + Math.floor(diff / 60000) + ' Ø¯Ù‚ÙŠÙ‚Ø©';
    if (diff < 86400000) return 'Ù‚Ø¨Ù„ ' + Math.floor(diff / 3600000) + ' Ø³Ø§Ø¹Ø©';
    return date.toLocaleDateString('ar-SA');
  }

  addPostBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    const title = postTitleInput.value.trim();
    const content = postContentInput.value.trim();
    const author = postAuthorInput.value.trim();
    const imageFile = postImageInput.files[0];

    if (!title || !content) {
      alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰');
      return;
    }

    const newRef = push(postsRef);
    const id = newRef.key;
    let imageURL = '';

    if (imageFile) {
      const storagePath = `posts/${id}_${imageFile.name}`;
      const sRef = storageRef(storage, storagePath);
      const uploadTask = uploadBytesResumable(sRef, imageFile);

      uploadProgress.style.display = 'block';

      uploadTask.on('state_changed',
        (snapshot) => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          progressBar.style.width = progress + '%';
        },
        (error) => {
          uploadProgress.style.display = 'none';
          alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ' + error.message);
        },
        async () => {
          imageURL = await getDownloadURL(uploadTask.snapshot.ref);
          savePost(newRef, title, content, author, imageURL);
        }
      );
    } else {
      savePost(newRef, title, content, author, '');
    }
  });

  async function savePost(newRef, title, content, author, imageURL) {
    const post = {
      title,
      text: content,
      author,
      image: imageURL || '',
      createdAt: new Date().toISOString()
    };
    
    try {
      await set(newRef, post);
      uploadProgress.style.display = 'none';
      progressBar.style.width = '0%';
      alert('âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!');
      
      // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
      postTitleInput.value = '';
      postContentInput.value = '';
      postAuthorInput.value = 'Ishraq Step';
      postImageInput.value = '';
    } catch (error) {
      alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø´Ø±: ' + error.message);
    }
  }

  function renderPosts() {
    postsContainer.innerHTML = '';
    
    if (!postsData || Object.keys(postsData).length === 0) {
      postsContainer.innerHTML = '<p style="color:white;text-align:center">ğŸš§ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù…Ø¶Ø§ÙØ©</p>';
      return;
    }

    // ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
    const sortedPosts = Object.entries(postsData).sort((a, b) => {
      return new Date(b[1].createdAt) - new Date(a[1].createdAt);
    });

    sortedPosts.forEach(([id, post]) => {
      const div = document.createElement('div');
      div.className = 'news-item';
      
      let html = `<h3>${escapeHtml(post.title)}</h3>`;
      if (post.image) {
        html += `<img src="${escapeHtml(post.image)}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±" onerror="this.src='https://picsum.photos/800/600'">`;
      }
      html += `
        <p>${escapeHtml(post.text)}</p>
        <p class="small">âœï¸ ${escapeHtml(post.author || 'Ù…Ø³ØªØ®Ø¯Ù…')} â€¢ ğŸ“… ${formatDate(post.createdAt)}</p>
        <button class="delete-btn" data-id="${id}">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>
      `;
      
      div.innerHTML = html;
      const deleteBtn = div.querySelector('.delete-btn');
      deleteBtn.addEventListener('click', () => deletePost(id));
      postsContainer.appendChild(div);
    });
  }

  async function deletePost(id) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ')) return;
    
    try {
      await remove(dbRef(db, `${POSTS_PATH}/${id}`));
      alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±');
    } catch (error) {
      alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ' + error.message);
    }
  }

</script>
</body>
</html>