<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ“ Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª - Ishraq Step</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  body{font-family:Cairo, sans-serif; background: linear-gradient(135deg,#4caf50,#00bcd4); margin:0; padding:20px; color:#333; direction:rtl}
  .card{max-width:980px;margin:20px auto;background:#fff;padding:16px;border-radius:12px;box-shadow:0 6px 24px rgba(2,6,23,0.08)}
  label{display:block;margin-top:10px;font-weight:700}
  input,textarea,select{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #e6eef6}
  .row{display:flex;gap:8px}
  .row > *{flex:1}
  .actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  button{padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
  .primary{background:linear-gradient(90deg,#ff8a00,#ffd166);color:#08121a}
  .muted{color:#667084;font-size:13px;margin-top:6px}
  .preview{border:1px solid #eef2f7;padding:12px;border-radius:10px;margin-top:12px}
  img.cover{max-width:140px;height:180px;object-fit:cover;border-radius:6px}
  .list{margin-top:18px}
  .list-item{border:1px solid #eef2f7;padding:10px;border-radius:8px;margin-bottom:10px;background:#fff;display:flex;gap:10px;align-items:center}
  .list-item .meta{flex:1}
  .small{font-size:12px;color:#666}
  .progress{height:8px;background:#eee;border-radius:6px;overflow:hidden;margin-top:8px;display:none}
  .progress > span{display:block;height:100%;background:linear-gradient(90deg,#4caf50,#00bcd4);width:0%}
  .nav-buttons{display:flex; gap:10px; justify-content:center; margin-bottom:16px; flex-wrap:wrap}
  .nav-btn{background:#fff; color:#4caf50; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:600; text-decoration:none; display:inline-flex; align-items:center; gap:8px}
  .nav-btn.active{background:#4caf50;color:#fff}
  .questions-list{margin-top:12px;border-top:1px dashed #eee;padding-top:12px}
  .question-item{display:flex;gap:8px;align-items:flex-start;border:1px solid #f1f5f9;padding:8px;border-radius:8px;margin-bottom:8px;background:#fff}
  .question-item img{width:80px;height:60px;object-fit:cover;border-radius:6px}
  .q-actions{display:flex;flex-direction:column;gap:6px}
  .choices{margin-top:8px}
  .choice-row{display:flex;gap:8px;align-items:center;margin-top:6px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:30px;background:#323232;color:#fff;padding:10px 16px;border-radius:8px;display:none;z-index:9999}
  .correct-badge{background:#4caf50;color:#fff;padding:2px 6px;border-radius:6px;font-size:12px;margin-right:6px}
</style>
</head>
<body>
  <div class="card">
    <h2>Ù„ÙˆØ­Ø© Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª (Ø£Ø¯Ù…Ù†)</h2>

    <div class="nav-buttons">
      <a href="courses.html" class="nav-btn">ğŸ“¹ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</a>
      <a href="books.html" class="nav-btn">ğŸ“˜ Ø§Ù„ÙƒØªØ¨</a>
      <a href="tests.html" class="nav-btn active">ğŸ“ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</a>
      <a href="../index.html" class="nav-btn">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </div>

    <label>Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯):</label>
    <input id="testId" placeholder="Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯">

    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
    <input id="title">

    <label>Ø§Ù„Ù…Ø¤Ù„Ù / Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯:</label>
    <input id="author" value="Ishraq Step">

    <label>Ø§Ù„Ù…Ø§Ø¯Ø© / Ø§Ù„Ù‚Ø³Ù…:</label>
    <input id="subject" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ - Ø­Ø±ÙˆÙ Ø§Ù„Ø¬Ø±">

    <div class="row" style="margin-top:8px">
      <div>
        <label>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† (Ù…Ø«Ø§Ù„: 100):</label>
        <input id="maxScore" type="number" min="0" value="100">
      </div>
      <div>
        <label>Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
        <input id="duration" type="number" min="0" placeholder="Ù…Ø«Ø§Ù„: 60">
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>ØºÙ„Ø§Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (ØµÙˆØ±Ø©) - Ø§Ø®ØªÙŠØ§Ø±ÙŠ:</label>
        <input id="coverFile" type="file" accept="image/*">
      </div>
      <div>
        <label>Ù„Ø§ ÙŠØªÙ… Ø±ÙØ¹ Ù…Ù„Ù PDF Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±. Ø§Ù„Ø¢Ù† ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ø£Ø¯Ù†Ø§Ù‡.</label>
      </div>
    </div>

    <hr style="margin-top:12px;border:none;border-top:1px solid #eef2f7">

    <h3>Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ù„Ù† ØªÙÙ†Ø´Ø± Ø­ØªÙ‰ ØªØ¶ØºØ· "Ø­ÙØ¸ / Ù†Ø´Ø±")</h3>
    <label>Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
    <textarea id="qText" rows="3" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§"></textarea>
    <label>ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
    <input id="qImage" type="file" accept="image/*">

    <label>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (4) â€” Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</label>
    <div class="choices" id="choicesContainer">
      <div class="choice-row">
        <input type="radio" name="correctChoice" value="0" id="c0">
        <input id="c0Text" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 1">
      </div>
      <div class="choice-row">
        <input type="radio" name="correctChoice" value="1" id="c1">
        <input id="c1Text" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 2">
      </div>
      <div class="choice-row">
        <input type="radio" name="correctChoice" value="2" id="c2">
        <input id="c2Text" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 3">
      </div>
      <div class="choice-row">
        <input type="radio" name="correctChoice" value="3" id="c3">
        <input id="c3Text" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 4">
      </div>
    </div>

    <div class="actions">
      <button id="addQuestionBtn">Ø£Ø¶Ù Ø³Ø¤Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      <button id="clearQuestionBtn">Ù…Ø³Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
    </div>

    <div class="questions-list" id="questionsList"><div class="small">Ù„Ù… ØªÙØ¶Ù Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯.</div></div>

    <div class="progress" id="uploadProgress"><span></span></div>

    <div class="actions">
      <button id="saveBtn" class="primary">Ø­ÙØ¸ / Ù†Ø´Ø±</button>
      <button id="clearBtn">Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
    </div>

    <div class="muted">Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ ÙŠÙÙ†Ø´Ø£ id Ø¬Ø¯ÙŠØ¯ (push) Ø¥Ø°Ø§ ØªØ±ÙƒØª Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹. Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²Ù†Ø©: id, title, author, subject, maxScore, duration, coverUrl, questions, createdAt, updatedAt.</div>

    <div class="preview" id="previewArea" aria-live="polite" hidden>
      <h3 id="pvTitle"></h3>
      <div style="display:flex;gap:12px;align-items:flex-start">
        <img id="pvCover" class="cover" src="" alt="ØºÙ„Ø§Ù">
        <div>
          <div id="pvAuthor" class="muted"></div>
          <div id="pvSubject" class="muted"></div>
          <div id="pvScore" class="muted"></div>
          <p id="pvQuestionsCount" class="muted"></p>
          <details style="margin-top:10px"><summary>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</summary><div id="pvDetails" style="padding-top:8px"></div></details>
        </div>
      </div>
    </div>

    <div class="list" id="testsList"><div class="small">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª...</div></div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    import { db, storage } from '../chat/js/fb.js';
    import { ref as dbRef, push, set, update, get, child, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { ref as sRef, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    const TESTS_PATH = 'tests';
    const testIdEl = document.getElementById('testId');
    const titleEl = document.getElementById('title');
    const authorEl = document.getElementById('author');
    const subjectEl = document.getElementById('subject');
    const maxScoreEl = document.getElementById('maxScore');
    const durationEl = document.getElementById('duration');
    const coverFileEl = document.getElementById('coverFile');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const previewArea = document.getElementById('previewArea');
    const pvTitle = document.getElementById('pvTitle');
    const pvCover = document.getElementById('pvCover');
    const pvAuthor = document.getElementById('pvAuthor');
    const pvSubject = document.getElementById('pvSubject');
    const pvScore = document.getElementById('pvScore');
    const pvQuestionsCount = document.getElementById('pvQuestionsCount');
    const pvDetails = document.getElementById('pvDetails');
    const testsList = document.getElementById('testsList');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = uploadProgress.querySelector('span');

    // Ø³Ø¤Ø§Ù„ UI
    const qTextEl = document.getElementById('qText');
    const qImageEl = document.getElementById('qImage');
    const addQuestionBtn = document.getElementById('addQuestionBtn');
    const clearQuestionBtn = document.getElementById('clearQuestionBtn');
    const questionsListEl = document.getElementById('questionsList');

    // Ø®ÙŠØ§Ø±Ø§Øª
    const cTextEls = [
      document.getElementById('c0Text'),
      document.getElementById('c1Text'),
      document.getElementById('c2Text'),
      document.getElementById('c3Text')
    ];

    let questions = []; // Ù…Ø®Ø²Ù† Ù…Ø¤Ù‚Øª Ù‚Ø¨Ù„ Ø§Ù„Ù†Ø´Ø±. Ø¹Ù†Ø§ØµØ±: { id, text, choices:[{text,isCorrect}], imageFile?, imageUrl? }

    function nowIso(){ return new Date().toISOString(); }
    function esc(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    function showToast(msg, ms=1600){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      setTimeout(()=> t.style.display = 'none', ms);
    }

    clearBtn.addEventListener('click', () => {
      testIdEl.value=''; titleEl.value=''; authorEl.value='Ishraq Step'; subjectEl.value=''; maxScoreEl.value='100'; durationEl.value='';
      coverFileEl.value=''; questions = []; renderQuestionsList(); previewArea.hidden=true;
      clearQuestionFields();
    });

    function clearQuestionFields(){
      qTextEl.value='';
      qImageEl.value='';
      cTextEls.forEach(e=> e.value='');
      const radios = document.getElementsByName('correctChoice');
      radios.forEach(r=> r.checked = false);
    }

    clearQuestionBtn.addEventListener('click', ()=> {
      clearQuestionFields();
    });

    addQuestionBtn.addEventListener('click', ()=> {
      const text = qTextEl.value.trim();
      if(!text){ alert('Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø£ÙˆÙ„Ø§Ù‹'); return; }
      // Ø¬Ù…Ø¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
      const choices = cTextEls.map((el, idx)=> ({ text: el.value.trim(), isCorrect: (document.getElementById('c'+idx).checked) }) );
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ 4 Ø®ÙŠØ§Ø±Ø§Øª ØºÙŠØ± ÙØ§Ø±ØºØ©
      const empty = choices.some(c=> !c.text);
      if(empty){ alert('Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©'); return; }
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ø¯ÙŠØ¯ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©
      const correctExists = choices.some(c=> c.isCorrect);
      if(!correctExists){ alert('Ø­Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©'); return; }

      const q = { id: 'q_' + Date.now(), text, choices };
      if(qImageEl.files && qImageEl.files[0]) q.imageFile = qImageEl.files[0];
      questions.push(q);

      // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± ØªÙÙŠØ¯ Ø¨Ø£Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø£Ø¶ÙŠÙ
      showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');

      // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
      clearQuestionFields();
      renderQuestionsList();
    });

    function renderQuestionsList(){
      if(!questions.length){ questionsListEl.innerHTML = '<div class="small">Ù„Ù… ØªÙØ¶Ù Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯.</div>'; return; }
      questionsListEl.innerHTML = '';
      questions.forEach((q, idx)=>{
        const div = document.createElement('div');
        div.className = 'question-item';
        const imgHtml = q.imageFile ? `<img src="${URL.createObjectURL(q.imageFile)}" alt="qimg">` :
                        q.imageUrl ? `<img src="${esc(q.imageUrl)}" alt="qimg">` : '';
        // Ø¹Ø±Ø¶ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø¹ ÙˆØ³Ù… Ø§Ù„ØµØ­ÙŠØ­
        const choicesHtml = (q.choices || []).map((ch, ci) => `<div class="small">${ch.isCorrect?'<span class="correct-badge">ØµØ­ÙŠØ­</span>':''}${esc(ch.text)}</div>`).join('');
        div.innerHTML = `
          <div style="flex:1">
            <div><strong>Ø³Ø¤Ø§Ù„ ${idx+1}</strong></div>
            <div style="margin-top:6px">${esc(q.text)}</div>
            <div style="margin-top:8px">${choicesHtml}</div>
          </div>
          ${imgHtml}
          <div class="q-actions">
            <button data-idx="${idx}" data-action="edit" style="padding:6px;border-radius:6px">ØªØ¹Ø¯ÙŠÙ„</button>
            <button data-idx="${idx}" data-action="delete" style="background:#f44336;color:white;border-radius:6px;padding:6px">Ø­Ø°Ù</button>
          </div>
        `;
        const editBtn = div.querySelector('[data-action="edit"]');
        const delBtn = div.querySelector('[data-action="delete"]');
        editBtn.addEventListener('click', ()=> {
          const q0 = questions[idx];
          qTextEl.value = q0.text || '';
          // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„
          (q0.choices || []).forEach((ch, i) => {
            if(cTextEls[i]) cTextEls[i].value = ch.text || '';
            const r = document.getElementById('c'+i);
            if(r) r.checked = !!ch.isCorrect;
          });
          qImageEl.value = '';
          // Ù†Ø²ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ± Ù„ÙƒÙŠ ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØªÙ‡ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
          questions.splice(idx,1);
          renderQuestionsList();
          window.scrollTo({top:0,behavior:'smooth'});
        });
        delBtn.addEventListener('click', ()=> {
          if(!confirm('Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ')) return;
          questions.splice(idx,1);
          renderQuestionsList();
        });
        questionsListEl.appendChild(div);
      });
    }

    const testsRef = dbRef(db, TESTS_PATH);
    onValue(testsRef, snapshot => {
      const data = snapshot.val() || {};
      renderTestsList(data);
    }, err => {
      testsList.innerHTML = '<div class="small">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</div>';
      console.error(err);
    });

    function renderTestsList(data){
      const entries = Object.entries(data || {});
      if(!entries.length){ testsList.innerHTML = '<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø¶Ø§ÙØ©</div>'; return; }
      testsList.innerHTML = '';
      entries.sort((a,b)=> new Date(b[1].createdAt||0) - new Date(a[1].createdAt||0));
      entries.forEach(([id, item])=>{
        const div = document.createElement('div');
        div.className = 'list-item';
        const cover = item.coverUrl || 'https://picsum.photos/120/160';
        const qCount = Array.isArray(item.questions) ? item.questions.length : 0;
        div.innerHTML = `
          <img src="${esc(cover)}" style="width:80px;height:110px;object-fit:cover;border-radius:6px">
          <div class="meta">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>${esc(item.title||'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†')}</strong><div class="small">${esc(item.author||'')}</div></div>
              <div class="small">${new Date(item.createdAt||0).toLocaleString('ar-SA')||''}</div>
            </div>
            <div class="small" style="margin-top:6px">Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${qCount} â€¢ Ø§Ù„Ù…Ø§Ø¯Ø©: ${esc(item.subject||'')}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button class="primary" data-id="${esc(id)}" data-action="edit">ØªØ¹Ø¯ÙŠÙ„</button>
            <button data-id="${esc(id)}" data-action="delete" style="background:#f44336;color:white;border-radius:6px;padding:6px 8px">Ø­Ø°Ù</button>
            <a href="../test.html?id=${encodeURIComponent(id)}" style="text-align:center;padding:6px;border-radius:6px;background:#eee;color:#111;text-decoration:none">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</a>
          </div>
        `;
        div.querySelector('[data-action="edit"]').addEventListener('click', ()=> loadTestIntoForm(id));
        div.querySelector('[data-action="delete"]').addEventListener('click', ()=> deleteTest(id));
        testsList.appendChild(div);
      });
    }

    async function loadTestIntoForm(id){
      try{
        const snap = await get(child(dbRef(db), `${TESTS_PATH}/${id}`));
        if(!snap.exists()){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±'); return; }
        const b = snap.val();
        testIdEl.value = id;
        titleEl.value = b.title || '';
        authorEl.value = b.author || '';
        subjectEl.value = b.subject || '';
        maxScoreEl.value = b.maxScore ?? 100;
        durationEl.value = b.duration || '';
        pvCover.src = b.coverUrl || '';
        pvTitle.textContent = b.title || '';
        pvAuthor.textContent = 'Ù…Ø¹Ø¯Ù‘ Ø¨ÙˆØ§Ø³Ø·Ø©: ' + (b.author || '');
        pvSubject.textContent = 'Ø§Ù„Ù…Ø§Ø¯Ø©: ' + (b.subject || '');
        pvScore.textContent = 'Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©: ' + (b.maxScore ?? '');
        const qs = Array.isArray(b.questions) ? b.questions : [];
        // Ù…Ù„Ø¡ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ imageUrl Ùˆ choices)
        questions = qs.map((x,i)=> ({ id: x.id || ('q_saved_'+i), text: x.text || '', imageUrl: x.imageUrl || '', choices: x.choices || [] }) );
        renderQuestionsList();
        pvQuestionsCount.textContent = 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ' + questions.length;
        pvDetails.innerHTML = questions.map((q,i)=> `<div><strong>Ø³${i+1}:</strong> ${esc(q.text)} ${(q.choices||[]).length?'<div class="small">Ø®ÙŠØ§Ø±Ø§Øª: '+ (q.choices.map(ch=> esc(ch.text) + (ch.isCorrect?' (âœ“)':'')).join(' | ')) +'</div>':''}</div>`).join('');
        previewArea.hidden = false;
        window.scrollTo({top:0,behavior:'smooth'});
      }catch(err){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + err.message); }
    }

    async function deleteTest(id){
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ')) return;
      try{
        await remove(dbRef(db, `${TESTS_PATH}/${id}`));
        alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù');
      }catch(err){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ' + err.message); }
    }

    saveBtn.addEventListener('click', async ()=>{
      const idInput = testIdEl.value.trim();
      const isEdit = !!idInput;
      const refNode = isEdit ? dbRef(db, `${TESTS_PATH}/${idInput}`) : push(dbRef(db, TESTS_PATH));
      const id = isEdit ? idInput : refNode.key;

      let coverUrl = '';
      try{
        // Ø±ÙØ¹ Ø§Ù„ØºÙ„Ø§Ù Ø¥Ù† ÙˆÙØ¬Ø¯
        if (coverFileEl.files[0]) {
          uploadProgress.style.display = 'block';
          const cRef = sRef(storage, `tests/${id}_cover_${Date.now()}_${coverFileEl.files[0].name}`);
          const up = uploadBytesResumable(cRef, coverFileEl.files[0]);
          await new Promise((res, rej) => up.on('state_changed',
            (snap)=> progressBar.style.width = (snap.bytesTransferred / snap.totalBytes) * 100 + '%',
            rej,
            async ()=>{ coverUrl = await getDownloadURL(up.snapshot.ref); res(); }
          ));
        }
        // Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ imageFile
        uploadProgress.style.display = 'block';
        for (let i=0;i<questions.length;i++){
          const q = questions[i];
          if (q.imageFile) {
            const qRef = sRef(storage, `tests/${id}_q_${i}_${Date.now()}_${q.imageFile.name}`);
            const upq = uploadBytesResumable(qRef, q.imageFile);
            await new Promise((res, rej) => upq.on('state_changed',
              (snap)=> progressBar.style.width = (snap.bytesTransferred / snap.totalBytes) * 100 + '%',
              rej,
              async ()=>{ q.imageUrl = await getDownloadURL(upq.snapshot.ref); delete q.imageFile; res(); }
            ));
          }
        }
      }catch(err){
        uploadProgress.style.display = 'none';
        alert('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª: ' + err.message);
        return;
      }
      uploadProgress.style.display = 'none';
      progressBar.style.width = '0%';

      // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ØµÙÙˆÙØ© Ù„Ù„Ø­ÙØ¸ (Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ text Ùˆ imageUrl Ùˆ id Ùˆ choices)
      const questionsToSave = questions.map((q,i)=>({
        id: q.id || ('q_' + i + '_' + Date.now()),
        text: q.text || '',
        imageUrl: q.imageUrl || '',
        choices: (q.choices || []).map(ch => ({ text: ch.text || '', isCorrect: !!ch.isCorrect }))
      }));

      const payload = {
        id,
        title: titleEl.value.trim(),
        author: authorEl.value.trim(),
        subject: subjectEl.value.trim(),
        maxScore: parseFloat(maxScoreEl.value) || 0,
        duration: durationEl.value ? parseInt(durationEl.value) : undefined,
        updatedAt: nowIso(),
        questions: questionsToSave
      };
      if (!isEdit) payload.createdAt = nowIso();
      if (coverUrl) payload.coverUrl = coverUrl;

      try{
        if(isEdit) await update(refNode, payload); else await set(refNode, payload);
        alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸. id = ' + id);
        testIdEl.value = id;
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
        pvTitle.textContent = payload.title || '';
        pvAuthor.textContent = 'Ù…Ø¹Ø¯Ù‘ Ø¨ÙˆØ§Ø³Ø·Ø©: ' + (payload.author || '');
        pvSubject.textContent = 'Ø§Ù„Ù…Ø§Ø¯Ø©: ' + (payload.subject || '');
        pvScore.textContent = 'Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©: ' + (payload.maxScore ?? '');
        pvQuestionsCount.textContent = 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ' + (payload.questions ? payload.questions.length : 0);
        pvDetails.innerHTML = (payload.questions || []).map((q,i)=> `<div><strong>Ø³${i+1}:</strong> ${esc(q.text)} ${(q.choices||[]).length?'<div class="small">Ø®ÙŠØ§Ø±Ø§Øª: '+ (q.choices.map(ch=> esc(ch.text) + (ch.isCorrect?' (âœ“)':'')).join(' | ')) +'</div>':''}</div>`).join('');
        if (payload.coverUrl) pvCover.src = payload.coverUrl;
        previewArea.hidden = false;
      }catch(err){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + err.message); }
    });
    console.log(addQuestionBtn, clearQuestionBtn);
  </script>
</body>
</html>