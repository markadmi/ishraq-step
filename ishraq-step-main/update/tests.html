<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ“ Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª - Ishraq Step</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  body{font-family:Cairo, sans-serif; background: linear-gradient(135deg,#4caf50,#00bcd4); margin:0; padding:20px; color:#333; direction:rtl}
  .card{max-width:980px;margin:20px auto;background:#fff;padding:16px;border-radius:12px;box-shadow:0 6px 24px rgba(2,6,23,0.08)}
  label{display:block;margin-top:10px;font-weight:700}
  input,textarea,select{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #e6eef6}
  .row{display:flex;gap:8px}
  .row > *{flex:1}
  .actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  button{padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
  .primary{background:linear-gradient(90deg,#ff8a00,#ffd166);color:#08121a}
  .muted{color:#667084;font-size:13px;margin-top:6px}
  .preview{border:1px solid #eef2f7;padding:12px;border-radius:10px;margin-top:12px}
  img.cover{max-width:140px;height:180px;object-fit:cover;border-radius:6px}
  .list{margin-top:18px}
  .list-item{border:1px solid #eef2f7;padding:10px;border-radius:8px;margin-bottom:10px;background:#fff;display:flex;gap:10px;align-items:center}
  .list-item .meta{flex:1}
  .small{font-size:12px;color:#666}
  .progress{height:8px;background:#eee;border-radius:6px;overflow:hidden;margin-top:8px;display:none}
  .progress > span{display:block;height:100%;background:linear-gradient(90deg,#4caf50,#00bcd4);width:0%}
  .nav-buttons{display:flex; gap:10px; justify-content:center; margin-bottom:16px; flex-wrap:wrap}
  .nav-btn{background:#fff; color:#4caf50; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:600; text-decoration:none; display:inline-flex; align-items:center; gap:8px}
  .nav-btn.active{background:#4caf50;color:#fff}
</style>
</head>
<body>
  <div class="card">
    <h2>Ù„ÙˆØ­Ø© Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª (Ø£Ø¯Ù…Ù†)</h2>

    <div class="nav-buttons">
      <a href="courses.html" class="nav-btn">ğŸ“¹ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</a>
      <a href="books.html" class="nav-btn">ğŸ“˜ Ø§Ù„ÙƒØªØ¨</a>
      <a href="tests.html" class="nav-btn active">ğŸ“ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</a>
      <a href="../index.html" class="nav-btn">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </div>

    <label>Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯):</label>
    <input id="testId" placeholder="Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯">

    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
    <input id="title">

    <label>Ø§Ù„Ù…Ø¤Ù„Ù / Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯:</label>
    <input id="author" value="Ishraq Step">

    <label>Ø§Ù„ÙˆØµÙ Ø§Ù„Ù…Ø®ØªØµØ±:</label>
    <input id="description">

    <label>Ø§Ù„Ù…Ø§Ø¯Ø© / Ø§Ù„Ù‚Ø³Ù…:</label>
    <input id="subject" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ - Ø­Ø±ÙˆÙ Ø§Ù„Ø¬Ø±">

    <div class="row" style="margin-top:8px">
      <div>
        <label>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† (Ù…Ø«Ø§Ù„: 100):</label>
        <input id="maxScore" type="number" min="0" value="100">
      </div>
      <div>
        <label>Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
        <input id="duration" type="number" min="0" placeholder="Ù…Ø«Ø§Ù„: 60">
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>ØºÙ„Ø§Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (ØµÙˆØ±Ø©) - Ø§Ø®ØªÙŠØ§Ø±ÙŠ:</label>
        <input id="coverFile" type="file" accept="image/*">
      </div>
      <div>
        <label>Ù…Ù„Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (PDF):</label>
        <input id="testFile" type="file" accept=".pdf,application/pdf">
      </div>
    </div>

    <div class="progress" id="uploadProgress"><span></span></div>

    <div class="actions">
      <button id="saveBtn" class="primary">Ø­ÙØ¸ / Ù†Ø´Ø±</button>
      <button id="clearBtn">Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
    </div>

    <div class="muted">Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ ÙŠÙÙ†Ø´Ø£ id Ø¬Ø¯ÙŠØ¯ (push) Ø¥Ø°Ø§ ØªØ±ÙƒØª Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹. Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²Ù†Ø©: id, title, author, description, subject, maxScore, duration, pages, size, coverUrl, fileUrl, createdAt, updatedAt.</div>

    <div class="preview" id="previewArea" aria-live="polite" hidden>
      <h3 id="pvTitle"></h3>
      <div style="display:flex;gap:12px;align-items:flex-start">
        <img id="pvCover" class="cover" src="" alt="ØºÙ„Ø§Ù">
        <div>
          <div id="pvAuthor" class="muted"></div>
          <div id="pvSubject" class="muted"></div>
          <div id="pvPages" class="muted"></div>
          <div id="pvScore" class="muted"></div>
          <p id="pvDescription"></p>
          <a id="pvFileLink" href="#" target="_blank" rel="noopener">ÙØªØ­ Ø§Ù„Ù…Ù„Ù (Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸)</a>
        </div>
      </div>
      <details style="margin-top:10px"><summary>ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©</summary><div id="pvDetails" style="padding-top:8px"></div></details>
    </div>

    <div class="list" id="testsList"><div class="small">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª...</div></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    }
  </script>

  <script>
    (function(){
      const testFileEl = document.getElementById('testFile');
      window.computedPages = window.computedPages ?? null;
      window.computedSize = window.computedSize ?? '';
      function formatBytes(bytes, decimals = 1) {
        if (bytes === undefined || bytes === null) return '';
        const k = 1024;
        const dm = Math.max(0, decimals);
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = bytes === 0 ? 0 : Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
      }
      if (testFileEl) {
        testFileEl.addEventListener('change', () => {
          const f = testFileEl.files[0];
          window.computedSize = f ? formatBytes(f.size, 1) : '';
          if (f && (f.type === 'application/pdf' || /\.pdf$/i.test(f.name)) && window.pdfjsLib) {
            const reader = new FileReader();
            reader.onload = function(e){
              try {
                const typed = new Uint8Array(e.target.result);
                pdfjsLib.getDocument({data: typed}).promise
                  .then(pdf => { window.computedPages = pdf.numPages; updatePreviewPages(); })
                  .catch(() => { window.computedPages = null; updatePreviewPages(); });
              } catch(_) { window.computedPages = null; updatePreviewPages(); }
            };
            reader.readAsArrayBuffer(f);
          } else {
            window.computedPages = null;
            updatePreviewPages();
          }
          updatePreviewPages();
        });
      }
      function updatePreviewPages(){
        const pvPages = document.getElementById('pvPages');
        if(!pvPages) return;
        const p = window.computedPages ?? null;
        const s = window.computedSize || '';
        pvPages.textContent = 'Ø§Ù„ØµÙØ­Ø§Øª: ' + (p ? p : 'â€”') + (s ? ' â€¢ Ø§Ù„Ø­Ø¬Ù…: ' + s : '');
      }
    })();
  </script>

  <script type="module">
    import { db, storage } from '../chat/js/fb.js';
    import { ref as dbRef, push, set, update, get, child, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { ref as sRef, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    const TESTS_PATH = 'tests';
    const testIdEl = document.getElementById('testId');
    const titleEl = document.getElementById('title');
    const authorEl = document.getElementById('author');
    const descriptionEl = document.getElementById('description');
    const subjectEl = document.getElementById('subject');
    const maxScoreEl = document.getElementById('maxScore');
    const durationEl = document.getElementById('duration');
    const coverFileEl = document.getElementById('coverFile');
    const testFileEl = document.getElementById('testFile');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const previewArea = document.getElementById('previewArea');
    const pvTitle = document.getElementById('pvTitle');
    const pvCover = document.getElementById('pvCover');
    const pvAuthor = document.getElementById('pvAuthor');
    const pvSubject = document.getElementById('pvSubject');
    const pvPages = document.getElementById('pvPages');
    const pvScore = document.getElementById('pvScore');
    const pvDescription = document.getElementById('pvDescription');
    const pvDetails = document.getElementById('pvDetails');
    const pvFileLink = document.getElementById('pvFileLink');
    const testsList = document.getElementById('testsList');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = uploadProgress.querySelector('span');

    function nowIso(){ return new Date().toISOString(); }
    function esc(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    clearBtn.addEventListener('click', () => {
      testIdEl.value=''; titleEl.value=''; authorEl.value='Ishraq Step'; descriptionEl.value=''; subjectEl.value=''; maxScoreEl.value='100'; durationEl.value='';
      coverFileEl.value=''; testFileEl.value=''; previewArea.hidden=true;
    });

    const testsRef = dbRef(db, TESTS_PATH);
    onValue(testsRef, snapshot => {
      const data = snapshot.val() || {};
      renderTestsList(data);
    }, err => {
      testsList.innerHTML = '<div class="small">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</div>';
      console.error(err);
    });

    function renderTestsList(data){
      const entries = Object.entries(data || {});
      if(!entries.length){ testsList.innerHTML = '<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø¶Ø§ÙØ©</div>'; return; }
      testsList.innerHTML = '';
      entries.sort((a,b)=> new Date(b[1].createdAt||0) - new Date(a[1].createdAt||0));
      entries.forEach(([id, item])=>{
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <img src="${esc(item.coverUrl || 'https://picsum.photos/120/160')}" style="width:80px;height:110px;object-fit:cover;border-radius:6px">
          <div class="meta">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>${esc(item.title||'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†')}</strong><div class="small">${esc(item.author||'')}</div></div>
              <div class="small">${new Date(item.createdAt||0).toLocaleString('ar-SA')||''}</div>
            </div>
            <div class="small" style="margin-top:6px">${esc(item.description||'')}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button class="primary" data-id="${esc(id)}" data-action="edit">ØªØ¹Ø¯ÙŠÙ„</button>
            <button data-id="${esc(id)}" data-action="delete" style="background:#f44336;color:white;border-radius:6px;padding:6px 8px">Ø­Ø°Ù</button>
            <a href="../test.html?id=${encodeURIComponent(id)}" style="text-align:center;padding:6px;border-radius:6px;background:#eee;color:#111;text-decoration:none">Ù…Ø¹Ø§ÙŠÙ†Ø©</a>
          </div>
        `;
        div.querySelector('[data-action="edit"]').addEventListener('click', ()=> loadTestIntoForm(id));
        div.querySelector('[data-action="delete"]').addEventListener('click', ()=> deleteTest(id));
        testsList.appendChild(div);
      });
    }

    async function loadTestIntoForm(id){
      try{
        const snap = await get(child(dbRef(db), `${TESTS_PATH}/${id}`));
        if(!snap.exists()){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±'); return; }
        const b = snap.val();
        testIdEl.value = id;
        titleEl.value = b.title || '';
        authorEl.value = b.author || '';
        descriptionEl.value = b.description || '';
        subjectEl.value = b.subject || '';
        maxScoreEl.value = b.maxScore ?? 100;
        durationEl.value = b.duration || '';
        window.computedPages = b.pages ?? null;
        window.computedSize = b.size || '';
        pvCover.src = b.coverUrl || '';
        pvTitle.textContent = b.title || '';
        pvAuthor.textContent = 'Ù…Ø¹Ø¯Ù‘ Ø¨ÙˆØ§Ø³Ø·Ø©: ' + (b.author || '');
        pvSubject.textContent = 'Ø§Ù„Ù…Ø§Ø¯Ø©: ' + (b.subject || '');
        pvPages.textContent = 'Ø§Ù„ØµÙØ­Ø§Øª: ' + (window.computedPages ?? 'â€”') + (window.computedSize ? ' â€¢ Ø§Ù„Ø­Ø¬Ù…: ' + window.computedSize : '');
        pvScore.textContent = 'Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©: ' + (b.maxScore ?? '');
        pvDescription.textContent = b.description || '';
        pvDetails.innerHTML = ''; 
        pvFileLink.href = b.fileUrl || '#';
        previewArea.hidden = false;
        window.scrollTo({top:0,behavior:'smooth'});
      }catch(err){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + err.message); }
    }

    async function deleteTest(id){
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ')) return;
      try{
        await remove(dbRef(db, `${TESTS_PATH}/${id}`));
        alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù');
      }catch(err){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ' + err.message); }
    }

    saveBtn.addEventListener('click', async ()=>{
      const idInput = testIdEl.value.trim();
      const isEdit = !!idInput;
      const refNode = isEdit ? dbRef(db, `${TESTS_PATH}/${idInput}`) : push(dbRef(db, TESTS_PATH));
      const id = isEdit ? idInput : refNode.key;

      let coverUrl = '';
      let fileUrl = '';

      try{
        if (coverFileEl.files[0]) {
          uploadProgress.style.display = 'block';
          const cRef = sRef(storage, `tests/${id}_cover_${coverFileEl.files[0].name}`);
          const up = uploadBytesResumable(cRef, coverFileEl.files[0]);
          await new Promise((res, rej) => up.on('state_changed',
            (snap)=> progressBar.style.width = (snap.bytesTransferred / snap.totalBytes) * 100 + '%',
            rej,
            async ()=>{ coverUrl = await getDownloadURL(up.snapshot.ref); res(); }
          ));
        }
        if (testFileEl.files[0]) {
          uploadProgress.style.display = 'block';
          const fRef = sRef(storage, `tests/${id}_file_${testFileEl.files[0].name}`);
          const up2 = uploadBytesResumable(fRef, testFileEl.files[0]);
          await new Promise((res, rej) => up2.on('state_changed',
            (snap)=> progressBar.style.width = (snap.bytesTransferred / snap.totalBytes) * 100 + '%',
            rej,
            async ()=>{ fileUrl = await getDownloadURL(up2.snapshot.ref); res(); }
          ));
        }
      }catch(err){
        uploadProgress.style.display = 'none';
        alert('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª: ' + err.message);
        return;
      }
      uploadProgress.style.display = 'none';
      progressBar.style.width = '0%';

      const payload = {
        id,
        title: titleEl.value.trim(),
        author: authorEl.value.trim(),
        description: descriptionEl.value.trim() || undefined,
        subject: subjectEl.value.trim(),
        maxScore: parseFloat(maxScoreEl.value) || 0,
        duration: durationEl.value ? parseInt(durationEl.value) : undefined,
        pages: window.computedPages ? parseInt(window.computedPages) : null,
        size: window.computedSize || '',
        updatedAt: nowIso()
      };
      if (!isEdit) payload.createdAt = nowIso();
      if (coverUrl) payload.coverUrl = coverUrl;
      if (fileUrl) payload.fileUrl = fileUrl;

      try{
        if(isEdit) await update(refNode, payload); else await set(refNode, payload);
        alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸. id = ' + id);
        testIdEl.value = id;
        pvFileLink.href = payload.fileUrl || '#';
      }catch(err){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + err.message); }
    });
  </script>
</body>
</html>